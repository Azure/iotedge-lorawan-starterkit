
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.4">
    
    
      
        <title>Message Flows - IoTEdge LoRaWAN StarterKit - documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bb3983ee.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#message-flows" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        <aside class="md-banner md-banner--warning">
          
        </aside>
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="IoTEdge LoRaWAN StarterKit - documentation" class="md-header__button md-logo" aria-label="IoTEdge LoRaWAN StarterKit - documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            IoTEdge LoRaWAN StarterKit - documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Message Flows
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Azure/iotedge-lorawan-starterkit/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../quickstart/" class="md-tabs__link">
      Quick Start
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../devguide/" class="md-tabs__link md-tabs__link--active">
        User Guide
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../samples/arduino/" class="md-tabs__link">
        Samples
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../testing/e2e_tests/" class="md-tabs__link">
        Testing
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/device-provisioning/" class="md-tabs__link">
        Tools
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../adr/001_region_cn470_implementation/" class="md-tabs__link">
        Decision Log
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../issues/" class="md-tabs__link">
        About
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="IoTEdge LoRaWAN StarterKit - documentation" class="md-nav__button md-logo" aria-label="IoTEdge LoRaWAN StarterKit - documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    IoTEdge LoRaWAN StarterKit - documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Azure/iotedge-lorawan-starterkit/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        Quick Start
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          User Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="User Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          User Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../devguide/" class="md-nav__link">
        Developer Guidance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        Architecture and Concepts for the LoRaWAN starter kit
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Message Flows
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Message Flows
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#defaultloradatarequesthandlerprocessrequestasync" class="md-nav__link">
    DefaultLoRaDataRequestHandler:ProcessRequestAsync
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#incoming-message-device-not-cached" class="md-nav__link">
    Incoming message - device not cached
  </a>
  
    <nav class="md-nav" aria-label="Incoming message - device not cached">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#observations" class="md-nav__link">
    Observations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#incoming-message-device-cached" class="md-nav__link">
    Incoming message - device cached
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#join-request-otaa" class="md-nav__link">
    Join Request - OTAA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-getdevice-otaa" class="md-nav__link">
    Function GetDevice - OTAA
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../partner/" class="md-nav__link">
        Device Manufacturer Guidance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../caching/" class="md-nav__link">
        Caching
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../upgrade/" class="md-nav__link">
        Upgrade LoRaWAN to a new version
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../documentation/" class="md-nav__link">
        Working with the documentation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../observability/" class="md-nav__link">
        Observability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ci-setup/" class="md-nav__link">
        CI setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_10" type="checkbox" id="__nav_3_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_10">
          Basic Station configuration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Basic Station configuration" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_10">
          <span class="md-nav__icon md-icon"></span>
          Basic Station configuration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../station-device-provisioning/" class="md-nav__link">
        Concentrator provisioning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../station-authentication-modes/" class="md-nav__link">
        Authentication modes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../station-module-configuration/" class="md-nav__link">
        `LoRaBasicsStationModule` IoT Edge Module configuration parameters
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Samples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Samples" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Samples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../samples/arduino/" class="md-nav__link">
        Arduino Demo Code
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Decoders
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Decoders" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Decoders
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../samples/decoders/decoder/" class="md-nav__link">
        Decoder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../samples/decoders/universal/" class="md-nav__link">
        Universal Decoder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../samples/decoders/cayenne/" class="md-nav__link">
        Cayenne Decoder
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Testing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Testing" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Testing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/e2e_tests/" class="md-nav__link">
        E2E Tests
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/integration_tests/" class="md-nav__link">
        Integration Tests
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tools" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/device-provisioning/" class="md-nav__link">
        LoRa device provisioning CLI
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Decision Log
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Decision Log" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Decision Log
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/001_region_cn470_implementation/" class="md-nav__link">
        001. Region CN470 implementation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/002_lbs_configuration/" class="md-nav__link">
        002. LoRa Basic Station configuration endpoint implementation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/003_documentation/" class="md-nav__link">
        003. Documentation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/004_region_as923_implementation/" class="md-nav__link">
        004. Region AS923 implementation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/005_observability/" class="md-nav__link">
        005 - Observability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/006_cups/" class="md-nav__link">
        006. CUPS Protocol Implementation - Credential management
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          About
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="About" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../issues/" class="md-nav__link">
        Known Issues
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../support/" class="md-nav__link">
        Support
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../license/" class="md-nav__link">
        License
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#defaultloradatarequesthandlerprocessrequestasync" class="md-nav__link">
    DefaultLoRaDataRequestHandler:ProcessRequestAsync
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#incoming-message-device-not-cached" class="md-nav__link">
    Incoming message - device not cached
  </a>
  
    <nav class="md-nav" aria-label="Incoming message - device not cached">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#observations" class="md-nav__link">
    Observations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#incoming-message-device-cached" class="md-nav__link">
    Incoming message - device cached
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#join-request-otaa" class="md-nav__link">
    Join Request - OTAA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-getdevice-otaa" class="md-nav__link">
    Function GetDevice - OTAA
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/Azure/iotedge-lorawan-starterkit/edit/docs/main/docs/user-guide/message-flows.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="message-flows">Message Flows</h1>
<h2 id="defaultloradatarequesthandlerprocessrequestasync">DefaultLoRaDataRequestHandler:ProcessRequestAsync</h2>
<div class="mermaid">flowchart TB
  ProcessRequestAsync--&gt;ReqVal{IsValidRequest?}
  ReqVal--&gt;|Yes|PerformADR
  ReqVal--&gt;|No|Done
  PerformADR--&gt;DedupDrop{MultiGW &amp; Drop?}
  DedupDrop--&gt;|Yes|Done
  DedupDrop--&gt;|No|ReqConf{Requires confirmation?}
  ReqConf--&gt;|No|HasValidFctUp{Has valid fcnt down?}
  ReqConf--&gt;|Yes|HasFctDown
  HasFctDown--&gt;|No|Done
  HasFctDown--&gt;|Yes|HasValidFctUp{Has valid fcnt up?}
  HasValidFctUp--&gt;decryptPayload[decrypt payload]
  decryptPayload--&gt;IsMacAnswer{Is Mac answer?}
  IsMacAnswer--&gt;|Yes|ValidFctDwn{Has valid fct down?}
  ValidFctDwn--&gt;|No|Done
  ValidFctDwn--&gt;|Yes|CheckSendDeviceEvt
  IsMacAnswer--&gt;|No|DecodePayload
  DecodePayload--&gt;C2DMsg{Has C2D msg?}
  C2DMsg--&gt;|Yes|CheckSameDevice{Is for same device?}
  CheckSameDevice--&gt;|Yes|ValidFctDwn2{Has valid fcnt down?}
  ValidFctDwn2--&gt;|Yes|CheckSendDeviceEvt
  ValidFctDwn2--&gt;|No|C2DAbandonAsync
  C2DAbandonAsync--&gt;CheckSendDeviceEvt
  CheckSameDevice--&gt;|No|SendC2DClassC
  SendC2DClassC--&gt;CheckSendDeviceEvt
  C2DMsg--&gt;|No|CheckSendDeviceEvt{Should send event upstream?}
  CheckSendDeviceEvt--&gt;|Yes|SendDeviceEventAsync
  SendDeviceEventAsync--&gt;ValidateTime{Still time for Rx Wnd?}
  CheckSendDeviceEvt--&gt;|No|ValidateTime
  ValidateTime--&gt;|No|Done
  ValidateTime--&gt;|Yes|ConfirmDirect{Confirmation and no downlink or not enough time?}
  ConfirmDirect--&gt;|Yes|SendDownlinkMsg
  ConfirmDirect--&gt;|No|ifC2DFromDecoder{C2D msg from decoder?}
  ifC2DFromDecoder--&gt;|Yes|SendDownlinkMsg
  ifC2DFromDecoder--&gt;|No|fetchC2D
  fetchC2D--&gt;RequiresConfirmation{Requires confirmation?}
  RequiresConfirmation--&gt;|Yes|check2ndC2DTime{Enough time for 2nd C2D msg?}
  RequiresConfirmation--&gt;|No|ValidFctDwn3{Has valid fcnt down?}
  ValidFctDwn3--&gt;|Yes|check2ndC2DTime
  ValidFctDwn3--&gt;|No|Done
  check2ndC2DTime--&gt;|Yes|CheckAdditionalMessages
  CheckAdditionalMessages--&gt;additionalC2DMsg{Has more messages?}
  additionalC2DMsg--&gt;|Yes|setFpending[set fpending]
  additionalC2DMsg--&gt;|No|SendDownlinkMsg
  setFpending--&gt;SendDownlinkMsg
  check2ndC2DTime--&gt;|No|SendDownlinkMsg
  SendDownlinkMsg--&gt;Done(Done)</div>
<h2 id="incoming-message-device-not-cached">Incoming message - device not cached</h2>
<div class="mermaid">sequenceDiagram
autonumber
MessageDispatcher-&gt;&gt;LoRaDeviceRegistry: GetLoRaRequestQueue
LoRaDeviceRegistry-&gt;&gt;DeviceLoaderSynchronizer: ctor
DeviceLoaderSynchronizer-&gt;&gt;DeviceLoaderSynchronizer: Load
LoRaDeviceRegistry-&gt;&gt;MessageDispatcher: DeviceLoaderSynchronizer
MessageDispatcher-&gt;&gt;DeviceLoaderSynchronizer: Queue
DeviceLoaderSynchronizer-&gt;&gt;API: SearchByDevAddrAsync
DeviceLoaderSynchronizer-&gt;&gt;DeviceLoaderSynchronizer: CreateDevicesAsync
loop For each Device
DeviceLoaderSynchronizer-&gt;&gt;LoRaDeviceFactory: Create
LoRaDeviceFactory-&gt;&gt;LoRaDeviceFactory: CreateDeviceClient
DeviceLoaderSynchronizer-&gt;&gt;LoRaDevice: InitializeAsync
LoRaDevice-&gt;&gt;LoRaDeviceClient: GetTwinAsync
end

DeviceLoaderSynchronizer-&gt;&gt;DeviceLoaderSynchronizer: DispatchQueuedItems
DeviceLoaderSynchronizer-&gt;&gt;LoRaDevice: Queue
LoRaDevice-&gt;&gt;DefaultLoRaDataRequestHandler: ProcessRequestAsync</div>
<ol>
<li>The message dispatcher requests the <code>ILoRaDeviceRequestQueue</code> from the <code>LoRaDeviceRegistry</code> where the <code>LoRaRequest</code> can be sent to. The <code>LoRaDeviceRegistry</code> maintains an in memory cache per <code>DevAddr</code> and checks, if it has a cache and if it contains a valid device matching the <code>NwkSKey</code>.  If it does not, the <code>LoRaDeviceRegistry</code> initializes a <code>DeviceLoaderSynchronizer</code> as <code>ILoRaDeviceRequestQueue</code>, and adds it to its cache under the prefix <code>devloader</code>.</li>
<li>The <code>DeviceLoaderSynchronizer</code> ctor does trigger an async initialization</li>
<li>Load of the devices matching the <code>DevAddr</code> is triggered</li>
<li>The <code>MessageDispatcher</code> receives the <code>DeviceLoaderSynchronizer</code></li>
<li>The original <code>LoRaRequest</code> is put onto the queue where it will wait for the device to be loaded.</li>
<li>The <code>SearchByDevAddrAsync</code>  is calling the function and tries to get a list for that particular <code>DevAddr</code> . The result is a list of <code>IoTHubDeviceInfo</code> which contains everything required to connect the device to IoT Hub as well as the <code>NwkSKey</code>.</li>
<li>The <code>DeviceLoaderSynchronizer</code> iterates over the result and asks for each of the result item to be materialized into a <code>LoRaDevice</code>.</li>
<li>The <code>LoRaDeviceFactory</code> creates a <code>LoRaDevice</code> from the <code>IoTHubDeviceInfo</code></li>
<li>The <code>LoRaDeviceFactory</code> also maintains the connections per device to IoT Hub. It does that through the <code>LoRaDeviceClientConnectionManager</code> where <code>LoRaDeviceClient</code> are registered per <code>DevEUI</code>.</li>
<li>Each device is initialized to get ready for processing messages</li>
<li>The initialization is triggering the load of the twins through the <code>LoRaDeviceClient</code></li>
<li>Once the device is initialized, the messages for the device are dispatched</li>
<li>The dispatch is putting them on the <code>LoRaDevice</code> Queue</li>
<li>The <code>LoRaDevice</code> will process the messages in sequence to avoid contention on the device connection and delegate the processing to the <code>ILoRaDataRequestHandler</code>.</li>
</ol>
<h3 id="observations">Observations</h3>
<ol>
<li>If the <code>DevAddr</code> does not match any of our registered devices, we keep the <code>DeviceLoaderSynchronizer</code>  in cache for 30s (which is designed to ensure that pending requests that were already on the queue, can be processed), then it's evicted.  Subsequent messages after those 30s with the same <code>DevAddr</code> will keep going back to the functions API. Given the fact that a device could be registered between messages, I don't see a way to avoid that except if we are willing to accept a longer period until we recognize a device. In that case we could register a 'drop' queue for the <code>DevAddr</code> that will be evicted after a longer time.</li>
</ol>
<h2 id="incoming-message-device-cached">Incoming message - device cached</h2>
<div class="mermaid">sequenceDiagram
autonumber
MessageDispatcher-&gt;&gt;LoRaDeviceRegistry: GetLoRaRequestQueue
alt in cache but not our device
LoRaDeviceRegistry-&gt;&gt;MessageDispatcher:ExternalGatewayLoRaRequestQueue:ctor
else
LoRaDeviceRegistry-&gt;&gt;MessageDispatcher:cached LoRaDevice
end
MessageDispatcher-&gt;&gt;LoRaDevice: Queue
LoRaDevice-&gt;&gt;DefaultLoRaDataRequestHandler: ProcessRequestAsync</div>
<ol>
<li>The message dispatcher requests the <code>ILoRaDeviceRequestQueue</code> from the <code>LoRaDeviceRegistry</code></li>
<li>If the device was in cache, but does not belong to our gateway, we return a <code>ExternalGatewayLoRaRequestQueue</code>. That queue is basically dropping any messages that are sent to it.</li>
<li>If the device was found in the cache we return that to the <code>MessageDispatcher</code>.</li>
<li>The request is put onto the <code>LoRaDevice</code>'s queue.</li>
<li>The <code>LoRaDevice</code> will process the messages in sequence to avoid contention on the device connection and delegate the processing to the <code>ILoRaDataRequestHandler</code>.</li>
</ol>
<h2 id="join-request-otaa">Join Request - OTAA</h2>
<div class="mermaid">sequenceDiagram
autonumber
MessageDispatcher-&gt;&gt;JoinRequestMessageHandler: DispatchRequest
JoinRequestMessageHandler-&gt;&gt;JoinRequestMessageHandler: ProcessJoinRequestAsync
JoinRequestMessageHandler-&gt;&gt;LoRaOperationTimeWatcher: ctor
JoinRequestMessageHandler-&gt;&gt;LoRaDeviceRegistry: GetDeviceForJoinRequestAsync
LoRaDeviceRegistry-&gt;&gt;API: SearchAndLockForJoinAsync
LoRaDeviceRegistry-&gt;&gt;JoinDeviceLoader: ctor
activate LoRaDevice
  par 
   JoinDeviceLoader-&gt;&gt;JoinDeviceLoader:LoadAsync
   JoinDeviceLoader-&gt;&gt;ILoRaDeviceFactory: Create
   ILoRaDeviceFactory--&gt;&gt;JoinDeviceLoader: LoRaDevice
   JoinDeviceLoader-&gt;&gt;LoRaDevice: InitializeAsync
   LoRaDevice-&gt;&gt;ILoRaDeviceClient: GetTwinAsync
  and
   LoRaDeviceRegistry-&gt;&gt;JoinDeviceLoader: WaitCompleteAsync
  end
JoinDeviceLoader--&gt;&gt;LoRaDeviceRegistry: LoRaDevice
LoRaDeviceRegistry--&gt;&gt;JoinRequestMessageHandler: LoRaDevice
JoinRequestMessageHandler--&gt;&gt;JoinRequestMessageHandler: Validation
JoinRequestMessageHandler-&gt;&gt;OTAAKeysGenerator: CalculateKey
JoinRequestMessageHandler-&gt;&gt;LoRaOperationTimeWatcher: InTimeForJoinAccept
JoinRequestMessageHandler-&gt;&gt;LoRaDevice: UpdateAfterJoinAsync
deactivate LoRaDevice
</div>
<ol>
<li>
<p>The <code>MessageDispatcher</code> delegates the handling of the join request to the <code>JoinRequestMessageHandler</code></p>
</li>
<li>
<p>The <code>JoinRequestMessageHandler</code> is executing <code>ProcessJoinRequestAsync</code> and extracts: DevEUI, AppEUI and DevNonce from the join request.</p>
</li>
<li>
<p>A <code>LoRaOperationTimeWatcher</code> is created to monitor the elapsed time for the join request.</p>
</li>
<li>
<p>The <code>LoRaDeviceRegistry</code> is queried for the device matching the join request.</p>
</li>
<li>
<p>The <code>LoRaDeviceRegistry</code> is asking the functions API to lookup the device using the DevEUI, AppEUI and the DevNonce. Also the Gateway Id is sent to allow locking the join request.  see the <a href="#function-GetDevice---OTAA">GetDevice flow</a></p>
<ol>
<li>Q: why do we send the <strong>AppEUI</strong>? It looks like that's not used for the OTAA join?</li>
</ol>
</li>
<li>
<p><code>LoRaDeviceRegistry</code> creates a new <code>JoinDeviceLoader</code> (unless the loader is still in the cache - valid for 30min) passing in the <code>IoTHubDeviceInfo</code>.</p>
</li>
<li>
<p>The <code>ctor</code> of the <code>JoinDeviceLoader</code> starts a thread executing <code>LoadAsync</code></p>
</li>
<li>
<p>A new <code>LoRaDevice</code> is created through the factory from the <code>IoTHubDeviceInfo</code></p>
</li>
<li>
<p><code>LoRaDevice</code> is returned.</p>
</li>
<li>
<p>The <code>LoRaDevice</code> is initialized.</p>
</li>
<li>
<p>Twins are loaded through the <code>ILoRaDeviceClient</code> (keys were fetched from the API).</p>
</li>
<li>
<p><code>JoinDeviceLoader</code> is waiting for completion of the device load process</p>
</li>
<li>
<p>The <code>LoRaDevice</code> is returned to the <code>LoRaDeviceRegistry</code></p>
</li>
<li>
<p>The <code>LoRaDevice</code> is returned to the <code>JoinRequestMessageHandler</code></p>
</li>
<li>
<p>Validation of the join request is performed (CheckMic, DevNonce, GatewayID)</p>
</li>
<li>
<p>Keys are generated</p>
</li>
<li>
<p>Validate that we can confirm the join to the device and are within <code>Join_accept_delay2</code> for the current region.</p>
</li>
<li>
<p>Writing <code>DevAddr</code>, <code>NwkSKey</code>, <code>AppSKey</code>, <code>AppNonce</code>, <code>DevNonce</code>, <code>NetID</code>, <code>Region</code>, <code>PreferredGatewayID</code></p>
</li>
<li>
<p>If we are still in time for a valid receive window, a <code>JoinAccept</code> will be sent to the device after calculating the DR and Frequency.</p>
</li>
</ol>
<h2 id="function-getdevice-otaa">Function GetDevice - OTAA</h2>
<div class="mermaid">sequenceDiagram
autonumber
LNS-&gt;&gt;DeviceGetter:GetDevice
DeviceGetter-&gt;&gt;DeviceGetter:TryGetJoinInfoAndValidateAsync
DeviceGetter-&gt;&gt;Redis:GetObject - JoinInfo
alt JoinInfo not in cache
DeviceGetter-&gt;&gt;RegistryManager: GetDeviceAsync
DeviceGetter-&gt;&gt;RegistryManager: GetTwinAsync
DeviceGetter-&gt;&gt;Redis: ObjectSet
end
alt if not our device
DeviceGetter--&gt;&gt;LNS: JoinRefused
end
DeviceGetter-&gt;&gt;Redis:StringSet
Note over DeviceGetter,Redis: Only if it does not exist, valid: 5min
alt if it did exist
   DeviceGetter--&gt;&gt;LNS: JoinRefused
else
   DeviceGetter-&gt;&gt;DeviceCache: TryToAcquireLock
   Note over DeviceGetter,DeviceCache: This tries to aquire a lock on the DevEUI
      alt if lock acquired
        DeviceGetter-&gt;&gt;DeviceCache: KeyDelete
          Note over DeviceGetter,DeviceCache: Delete DevEUI key from Redis
      else
        DeviceGetter-&gt;&gt;DeviceGetter: log warning
      end
    DeviceGetter-&gt;&gt;LNS: IoTHubDeviceInfo
end</div>
<ol>
<li>
<p>The LNS requests the device for a <a href="#Join-Request---OTAA">join request</a></p>
</li>
<li>
<p>The DeviceGetter calls <code>TryGetJoinInfoAndValidateAsync</code></p>
</li>
<li>
<p>Try to get the <code>JoinInfo</code> (containing the primary key and the desired gateway id for the device) from Redis.</p>
</li>
<li>
<p>If the device was not in the cache, we use the IoT Hub  <code>RegistryManager</code> to fetch the Device</p>
</li>
<li>
<p>If the device exists, we fetch the twins and get the Desired GatewayId.</p>
</li>
<li>
<p>The JoinInfo is stored in Redis for 60min</p>
</li>
<li>
<p>We validate that if there is a desired gateway, the gateway processing the join request, is the desired gateway. If not, a BadRequest is returned to the LNS indicating the join failure.</p>
</li>
<li>
<p>We try to set the DevEUI:Nonce value in Redis cache to ensure, only 1 Gateway is processing the join request</p>
</li>
<li>
<p>If we did not win the race, the Gateway receives a BadRequest response</p>
</li>
<li>
<p>If we were successful we create a <code>IoTHubDeviceInfo</code> and try to acquire a lock on the DevEUI</p>
</li>
<li>
<p>If we did get the lock, we delete the DevEUI key.</p>
</li>
<li>
<p>If not, we print out a warning</p>
</li>
<li>
<p>We return the <code>IoTHubDeviceInfo</code></p>
</li>
</ol>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../architecture/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Architecture and Concepts for the LoRaWAN starter kit" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Architecture and Concepts for the LoRaWAN starter kit
            </div>
          </div>
        </a>
      
      
        
        <a href="../partner/" class="md-footer__link md-footer__link--next" aria-label="Next: Device Manufacturer Guidance" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Device Manufacturer Guidance
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    <a href="https://github.com/Azure/iotedge-lorawan-starterkit" target="_blank" rel="noopener" title="iotedge-lorawan-starterkit on GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "navigation.tracking", "search.suggest", "search.highlight"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.361d90f1.min.js", "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.289a2a4b.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
      
    
  </body>
</html>