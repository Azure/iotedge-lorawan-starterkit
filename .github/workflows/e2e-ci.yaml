name: LoRa E2E CI
concurrency: e2e
on: # rebuild any PRs and main branch changes
  schedule:
    - cron: '59 23 * * *'
  workflow_dispatch:
    inputs:
      RunE2ETestsOnly:
        description: 'Run E2E tests only'
        default: false
      TestsToRun:
        default: '[\"SensorDecodingTest\",\"OTAAJoinTest\",\"ABPTest\",\"OTAATest\",\"MacTest\",\"ClassCTest\",\"C2DMessageTest\",\"MultiGatewayTest\"]'
        description: 'tests to run'
env:
  buildConfiguration: 'Release'
  AZURE_FUNCTIONAPP_NAME: loramoduleintegrationtest
  TESTS_FOLDER: Tests
  TESTS_RESULTS_FOLDER: Tests/TestResults

jobs:
  env_var:
    name: Set environment variables
    runs-on: ubuntu-latest
    steps:
    - id: e2e_list_step
      name: Set E2E tests to run
      run: |
        if [ ${{ github.event_name }} == 'workflow_dispatch' ]; then
          echo "Set up for workflow dispatch"
          echo "::set-output name=E2ETestsToRun::${{ github.event.inputs.TestsToRun }}"
        else
          echo "::set-output name=E2ETestsToRun::[\"SensorDecodingTest\",\"OTAAJoinTest\",\"ABPTest\",\"OTAATest\",\"MacTest\",\"ClassCTest\",\"C2DMessageTest\",\"MultiGatewayTest\"]"
        fi

    - id: check-if-run
      name: Check if deploy on local ci
      if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'fullci' ) != true
      run: |
        echo "::set-output name=StopFullCi::true"

    outputs:
      AZURE_FUNCTIONAPP_NAME: ${{ env.AZURE_FUNCTIONAPP_NAME }}
      RunE2ETestsOnly: ${{ github.event.inputs.RunE2ETestsOnly == 'true' || contains(github.event.client_payload.labels.*.name, 'RunE2ETestsOnly') == true}}
      E2ETestsToRun: ${{ steps.e2e_list_step.outputs.E2ETestsToRun }}
      StopFullCi: ${{ steps.check-if-run.outputs.StopFullCi }}

  # Build and deploy Facade Azure Function
  deploy_facade_function:
    needs:
    - env_var
    name: Build and Deploy Facade Azure Function
    runs-on: ubuntu-latest
    if: needs.env_var.outputs.RunE2ETestsOnly != 'true'
    env:
      AZURE_FUNCTIONAPP_PACKAGE_PATH: 'LoRaEngine/LoraKeysManagerFacade/'

    steps:
    - uses: actions/checkout@v2
      name: Checkout current branch

    - name: 'Resolve Project Dependencies Using Dotnet'
      shell: bash
      run: |
        pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
        dotnet build --configuration ${{ env.buildConfiguration }} --output ./output
        popd

    - name: 'Run Azure Functions Action'
      uses: Azure/functions-action@v1
      id: fa
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}output'
        publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}

  build_push_docker_images:
    needs:
    - env_var
    name: Build and Push Docker images
    runs-on: ubuntu-latest
    env:
      DEV_IMAGE_TAG: dev
      MASTER_IMAGE_TAG: master
    if: needs.env_var.outputs.RunE2ETestsOnly != 'true'
    steps:
    - uses: actions/checkout@v2
      name: Checkout current branch
      with:
        fetch-depth: '2'

    - run: |
        if [ ${{ github.ref	}} = "refs/heads/dev" ]; then
        echo "dev"
        IMAGE_TAG="$DEV_IMAGE_TAG"
        elif [ ${{ github.ref	}} = "refs/heads/master" ]; then
        echo "master"
        IMAGE_TAG="$MASTER_IMAGE_TAG"
        elif [ ${{ github.event_name }} == "pull_request" ]; then
        echo "pull request"
        IMAGE_TAG="pr-${{ github.event.number}}"
        else
        echo "all others"
        IMAGE_TAG="custom-${GITHUB_REF##*/}"
        fi
        echo "Using image tag prefix $IMAGE_TAG"
        IMAGE_TAG="$IMAGE_TAG-${{ github.run_number }}"
        echo "Using image tag $IMAGE_TAG"
        echo "::set-env name=NET_SRV_VERSION::$IMAGE_TAG"
        echo "::set-env name=LBS_VERSION::$IMAGE_TAG"
      env:
        ACTIONS_ALLOW_UNSECURE_COMMANDS: true
    - uses: docker/setup-buildx-action@v1
      id: buildx
      with:
         install: true
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1

    - name: Build Docker LoRaWanNetworkServer images
      run: |
        echo ${{ secrets.ACR_CREDENTIALS }} | docker login "loramoduleintegrationtest.azurecr.io" --username  "loramoduleintegrationtest" --password-stdin
        docker buildx bake --push LoRaWanNetworkServerarm32
      working-directory: LoRaEngine
      env:
        CONTAINER_REGISTRY_ADDRESS: "loramoduleintegrationtest.azurecr.io"

    # This image is very costly to rebuild and we rebuild it only when something change in the folders since last commit.
    - name: Build Docker LoRaWanBasicsStation images
      run: |
        git diff --quiet HEAD HEAD~1 -- modules/LoRaBasicsStationModule/ || docker buildx bake --push LoraBasicsStationarm32v7
      working-directory: LoRaEngine
      env:
        CONTAINER_REGISTRY_ADDRESS: "loramoduleintegrationtest.azurecr.io"

  # Deploy IoT Edge solution to ARM gateway
  deploy_arm_gw_iot_edge:
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        gateway: [ primary, secondary ]
        include:
          - gateway: primary
            architecture: arm32v7
          - gateway: secondary
            architecture: arm32v7
    needs:
    - env_var
    - build_push_docker_images
    if: needs.env_var.outputs.RunE2ETestsOnly != 'true'
    env:
      CONTAINER_REGISTRY_ADDRESS: "loramoduleintegrationtest.azurecr.io"
      CONTAINER_REGISTRY_SERVER: "loramoduleintegrationtest.azurecr.io"
      CONTAINER_REGISTRY_USERNAME: "loramoduleintegrationtest"
      CONTAINER_REGISTRY_PASSWORD: ${{ secrets.ACR_CREDENTIALS }}
      IOTHUB_CONNECTION_STRING: ${{ secrets.IOTHUB_CONNECTION_STRING }}
      IOT_EDGE_DEPLOYMENT_ID: "citest${{ matrix.gateway }}"
      NET_SRV_LOG_LEVEL: 1
      NET_SRV_LOGTO_UDP: true
      NET_SRV_IOTEDGE_TIMEOUT: 0
      NET_SRV_LOG_TO_UDP_ADDRESS: "itestup"
      EDGEHUB_ROUTE: "FROM /* INTO $upstream"
      RESET_PIN: 7
      REGION: "EU"
      FACADE_SERVER_URL: "https://${{ needs.env_var.outputs.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/"
      FACADE_AUTH_CODE: ${{ secrets.FUNCTION_AUTH_CODE }}
      EDGE_AGENT_VERSION: 1.2.2
      EDGE_HUB_VERSION: 1.2.2
      EDGEHUB_OPTIMIZEFORPERFORMANCE: false
      EDGEHUB_MQTTSETTINGS_ENABLED: false
      EDGEHUB_HTTPSETTINGS_ENABLED: false
      BUILD_BUILDID: ${{ github.run_id }}
      DEV_IMAGE_TAG: dev
      DEVICE_ID: ${{ matrix.gateway }}
      MASTER_IMAGE_TAG: master
      LBS_TC_URI: 'ws://172.17.0.1:5000'
    runs-on: ubuntu-latest
    name: Run IoT Edge Deployment on ARM gateway
    steps:
      - uses: actions/checkout@v2
        name: Checkout current branch

      - run: |
          if [ ${{ github.ref	}} = "refs/heads/dev" ]; then
          echo "dev"
          IMAGE_TAG="$DEV_IMAGE_TAG"
          elif [ ${{ github.ref	}} = "refs/heads/master" ]; then
          echo "master"
          IMAGE_TAG="$MASTER_IMAGE_TAG"
          elif [ ${{ github.event_name }} == "pull_request" ]; then
          echo "pull request"
          IMAGE_TAG="pr-${{ github.event.number}}"
          else
          echo "all others"
          IMAGE_TAG="custom-${GITHUB_REF##*/}"
          fi
          echo "Using image tag prefix $IMAGE_TAG"
          IMAGE_TAG="$IMAGE_TAG-${{ github.run_number }}"
          echo "Using image tag $IMAGE_TAG"
          echo "::set-env name=NET_SRV_VERSION::$IMAGE_TAG"
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: true

      # Replacement need to occur to be compliant with the IoT Edge tool, we should remove in the future.
      - run: |
          $LBS_IMAGE_TAG=$(az acr repository show-tags --username ${{ env.CONTAINER_REGISTRY_USERNAME }} --password ${{ env.CONTAINER_REGISTRY_PASSWORD }} --name ${{ env.CONTAINER_REGISTRY_ADDRESS }} --repository lorabasicsstation --orderby time_desc -o json | ConvertFrom-Json)[0]

          $LBS_IMAGE_TAG=$LBS_IMAGE_TAG.replace("-${{ matrix.architecture }}",'')
          echo $LBS_IMAGE_TAG
          echo "::set-env name=LBS_VERSION::$LBS_IMAGE_TAG"
        shell: pwsh
        name: Compute latest LBS build
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: true

      - name: Iot Edge Deploy
        uses: ./devops
        id: edgedev_deploy
        with:
          command: deploy
          folder_path: 'LoRaEngine'
          file_name: 'deployment.lbs.template.json'
          target_platform: ${{ matrix.architecture }}


      - name: Wait for IoT Edge Deployment
        run: |
          az extension add --name azure-iot
          until `az iot edge deployment show-metric --deployment-id $IOT_EDGE_DEPLOYMENT_ID --metric-id reportedSuccessfulCount --metric-type system --login '${{ secrets.IOTHUB_CONNECTION_STRING }}' | grep -q $DEVICE_ID`; do sleep 10 && echo wait; done

          # We add the 3 minutes sleep to let the container start up
          # TODO We might want to revisit this once there are some options to check that the network server started.
          sleep 3m

# Runs E2E tests in dedicated agent, while having modules deployed into PI (arm32v7)
  e2e_tests_job :
    name: Run E2E Tests
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        testsToRun: ${{ fromjson(needs.env_var.outputs.E2ETestsToRun) }}
    if: always() && (needs.env_var.outputs.RunE2ETestsOnly == 'true' || (needs.deploy_arm_gw_iot_edge.result == 'success' && needs.deploy_facade_function.result == 'success'))
    needs:
      - deploy_arm_gw_iot_edge
      - deploy_facade_function
      - env_var
    runs-on: [ self-hosted, x64 ]
    timeout-minutes: 60
    env:
      E2ETESTS_LeafDeviceSerialPort: '/dev/ttyACM0'
      E2ETESTS_IoTHubEventHubConsumerGroup: 'reserved_integrationtest_amd'
      E2ETESTS_LeafDeviceGatewayID: primary
      E2ETESTS_DevicePrefix: '01'
      E2ETESTS_EnsureHasEventDelayBetweenReadsInSeconds: 15
      E2ETESTS_EnsureHasEventMaximumTries: 5
      E2ETESTS_IoTHubConnectionString: ${{ secrets.IOTHUB_CONNECTION_STRING }}
      E2ETESTS_IoTHubEventHubConnectionString: ${{ secrets.IOTHUB_EVENT_HUB_CONNECTION_STRING }}
      E2ETESTS_FunctionAppCode: ${{ secrets.FUNCTION_AUTH_CODE }}
      E2ETESTS_FunctionAppBaseUrl: "https://${{ needs.env_var.outputs.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/"

    steps:
    - uses: actions/checkout@v2
      if: contains(github.event.pull_request.labels.*.name, matrix.testsToRun ) != true
      name: Checkout current branch

    - name: Setup .NET
      if: contains(github.event.pull_request.labels.*.name, matrix.testsToRun ) != true
      uses: actions/setup-dotnet@v1.8.2
      with:
        dotnet-version: '3.1.x' # SDK Version to use.

    - name: .NET SDK Information
      run: dotnet --info

    - name: Configuration for E2E tests
      uses: cschleiden/replace-tokens@v1
      if: contains(github.event.pull_request.labels.*.name, matrix.testsToRun ) != true
      with:
        files: '${{ env.TESTS_FOLDER }}/E2E/appsettings.json'

    # Builds and runs E2E tests
    - name: Build E2E tests
      if: contains(github.event.pull_request.labels.*.name, matrix.testsToRun ) != true
      run: dotnet build --configuration ${{ env.buildConfiguration }} ${{ env.TESTS_FOLDER }}/E2E/LoRaWan.Tests.E2E.csproj

    - name: Runs E2E tests ${{ matrix.testsToRun }}
      if: contains(github.event.pull_request.labels.*.name, matrix.testsToRun ) != true
      id: e2e_tests_step
      run: |
        echo ${{ matrix.testsToRun }}
        dotnet test --logger trx --no-build --configuration ${{ env.buildConfiguration }} \
        -p:ParallelizeTestCollections=false -r ${{ env.TESTS_RESULTS_FOLDER }}/E2E/ --filter "${{ matrix.testsToRun }}" \
        ${{ env.TESTS_FOLDER }}/E2E/LoRaWan.Tests.E2E.csproj

    # Upload test results as artifact
    - uses: actions/upload-artifact@v1
      if: (success() || failure()) && contains(github.event.pull_request.labels.*.name, matrix.testsToRun ) != true
      with:
        name: e2e-test-results
        path: ${{ env.TESTS_RESULTS_FOLDER }}/E2E/

    - name: Add ${{ matrix.testsToRun }} Test Label
      uses: buildsville/add-remove-label@v1
      if: github.event_name == 'pull_request' && steps.e2e_tests_step.conclusion == 'Success' && contains(github.event.pull_request.labels.*.name, matrix.testsToRun ) != true
      with:
        token: ${{secrets.GITHUB_TOKEN}}
        label: '${{ matrix.testsToRun }}'
        type: add


