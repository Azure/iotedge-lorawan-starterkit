{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.11.1.770",
      "templateHash": "7677750668131162841"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "uniqueSolutionPrefix": {
      "type": "string",
      "metadata": {
        "description": "Prefix used for resource names. Should be unique as this will also be used for domain names."
      }
    },
    "edgeGatewayName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Edge gateway"
      }
    },
    "deployDevice": {
      "type": "bool",
      "metadata": {
        "description": "Provision a final LoRa device in the IoT hub in addition to the gateway"
      }
    },
    "resetPin": {
      "type": "int",
      "metadata": {
        "description": "Provide the reset pin value of your gateway. Please refer to the doc if you are unfamiliar with the value"
      }
    },
    "region": {
      "type": "string",
      "defaultValue": "EU863",
      "allowedValues": [
        "EU863",
        "US902",
        "AS923-1",
        "AS923-2",
        "AS923-3",
        "CN470RP1",
        "CN470RP2",
        "AU915"
      ],
      "metadata": {
        "description": "In what region is your gateway deployed?"
      }
    },
    "stationEui": {
      "type": "string",
      "defaultValue": "AA555A0000000101",
      "metadata": {
        "description": "The StationEUI of the sample concentrator device"
      }
    },
    "spiSpeed": {
      "type": "int",
      "defaultValue": 8,
      "allowedValues": [
        8,
        2
      ],
      "metadata": {
        "description": "[In Mbps] Custom SPI speed for your gateway, currently only supported for ARM gateways"
      }
    },
    "spiDev": {
      "type": "int",
      "defaultValue": 0,
      "allowedValues": [
        0,
        1,
        2
      ],
      "metadata": {
        "description": "SPI Dev version for x86 based gateway"
      }
    },
    "useAzureMonitorOnEdge": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Controls whether observability is set up for IoT edge."
      }
    },
    "useDiscoveryService": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Controls whether the standalone discovery service should be deployed."
      }
    },
    "gitUsername": {
      "type": "string",
      "defaultValue": "Azure",
      "metadata": {
        "description": "The Git Username. Default is Azure."
      }
    },
    "version": {
      "type": "string",
      "defaultValue": "2.2.1",
      "metadata": {
        "description": "The LoRaWAN Starter Kit version to use."
      }
    },
    "loraCliUrl": {
      "type": "string",
      "defaultValue": "[format('https://github.com/Azure/iotedge-lorawan-starterkit/releases/download/v{0}/lora-cli.linux-musl-x64.tar.gz', parameters('version'))]",
      "metadata": {
        "description": "The location of the cli tool to be used for device provisioning."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "iotHub",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}hub', parameters('uniqueSolutionPrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "3201515198599049156"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Devices/IotHubs",
              "apiVersion": "2021-07-02",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": {
                "capacity": 1,
                "name": "S1"
              }
            }
          ],
          "outputs": {
            "iotHubName": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "storage",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "uniqueSolutionPrefix": {
            "value": "[parameters('uniqueSolutionPrefix')]"
          },
          "storageAccountType": {
            "value": "StorageV2"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "14715923028860611864"
            }
          },
          "parameters": {
            "uniqueSolutionPrefix": {
              "type": "string"
            },
            "storageAccountType": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "variables": {
            "storageAccountName": "[format('{0}storage', parameters('uniqueSolutionPrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-05-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "kind": "[parameters('storageAccountType')]",
              "sku": {
                "name": "Standard_LRS"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2022-05-01",
              "name": "[format('{0}/default/stationcredentials', variables('storageAccountName'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2022-05-01",
              "name": "[format('{0}/default/fwupgrades', variables('storageAccountName'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "value": "[variables('storageAccountName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "redisCache",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "uniqueSolutionPrefix": {
            "value": "[parameters('uniqueSolutionPrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "11840764698369256353"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The Azure location where to create the hosting plan. Default value is resource group location."
              }
            },
            "uniqueSolutionPrefix": {
              "type": "string",
              "metadata": {
                "description": "Prefix used for resource names. Should be unique as this will also be used for domain names."
              }
            }
          },
          "variables": {
            "redisCacheName": "[format('{0}redis', parameters('uniqueSolutionPrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Cache/redis",
              "apiVersion": "2022-06-01",
              "name": "[variables('redisCacheName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "capacity": 0,
                  "family": "C",
                  "name": "Basic"
                }
              }
            }
          ],
          "outputs": {
            "redisCacheName": {
              "type": "string",
              "value": "[variables('redisCacheName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "function",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'observability')).outputs.appInsightName.value]"
          },
          "logAnalyticsName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'observability')).outputs.logAnalyticsName.value]"
          },
          "uniqueSolutionPrefix": {
            "value": "[parameters('uniqueSolutionPrefix')]"
          },
          "useAzureMonitorOnEdge": {
            "value": "[parameters('useAzureMonitorOnEdge')]"
          },
          "hostingPlanLocation": {
            "value": "[parameters('location')]"
          },
          "redisCacheName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'redisCache')).outputs.redisCacheName.value]"
          },
          "iotHubName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'iotHub')).outputs.iotHubName.value]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage')).outputs.storageAccountName.value]"
          },
          "gitUsername": {
            "value": "[parameters('gitUsername')]"
          },
          "version": {
            "value": "[parameters('version')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "16153724991873724673"
            }
          },
          "parameters": {
            "gitUsername": {
              "type": "string"
            },
            "version": {
              "type": "string"
            },
            "hostingPlanLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "hostingPlanSkuName": {
              "type": "string",
              "defaultValue": "Y1",
              "metadata": {
                "description": "Hosting plan SKU. Default is Y1."
              }
            },
            "hostingPlanSkuTier": {
              "type": "string",
              "defaultValue": "Dynamic",
              "metadata": {
                "description": "Hosting Plan SKU tiers. Default value is Dynamic."
              }
            },
            "uniqueSolutionPrefix": {
              "type": "string"
            },
            "useAzureMonitorOnEdge": {
              "type": "bool"
            },
            "redisCacheName": {
              "type": "string"
            },
            "iotHubName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "logAnalyticsName": {
              "type": "string"
            },
            "appInsightName": {
              "type": "string"
            }
          },
          "variables": {
            "functionName": "[format('{0}function', parameters('uniqueSolutionPrefix'))]",
            "functionZipBinary": "[format('https://github.com/{0}/iotedge-lorawan-starterkit/releases/download/v{1}/function-{2}.zip', parameters('gitUsername'), parameters('version'), parameters('version'))]",
            "hostingPlanName": "[format('{0}plan', parameters('uniqueSolutionPrefix'))]",
            "iotHubOwnerPolicyName": "iothubowner"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-03-01",
              "name": "[variables('hostingPlanName')]",
              "location": "[parameters('hostingPlanLocation')]",
              "sku": {
                "name": "[parameters('hostingPlanSkuName')]",
                "tier": "[parameters('hostingPlanSkuTier')]"
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-03-01",
              "name": "[variables('functionName')]",
              "location": "[parameters('hostingPlanLocation')]",
              "kind": "functionapp",
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
                "siteConfig": {
                  "connectionStrings": [
                    {
                      "name": "IoTHubConnectionString",
                      "type": "Custom",
                      "connectionString": "[format('HostName={0}.azure-devices.net;SharedAccessKeyName={1};SharedAccessKey={2}', parameters('iotHubName'), variables('iotHubOwnerPolicyName'), listKeys(resourceId('Microsoft.Devices/IotHubs/IotHubKeys', parameters('iotHubName'), variables('iotHubOwnerPolicyName')), '2021-07-02').primaryKey)]"
                    },
                    {
                      "name": "RedisConnectionString",
                      "type": "Custom",
                      "connectionString": "[format('{0}.redis.cache.windows.net,abortConnect=false,ssl=true,password={1}', parameters('redisCacheName'), listKeys(resourceId('Microsoft.Cache/redis', parameters('redisCacheName')), '2022-06-01').primaryKey)]"
                    }
                  ],
                  "appSettings": [
                    {
                      "name": "AzureWebJobsDashboard",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2022-05-01').keys[0].value)]"
                    },
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2022-05-01').keys[0].value)]"
                    },
                    {
                      "name": "AzureWebJobsSecretStorageType",
                      "value": "Files"
                    },
                    {
                      "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2022-05-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTSHARE",
                      "value": "[toLower(variables('functionName'))]"
                    },
                    {
                      "name": "FACADE_HOST_NAME",
                      "value": "[toLower(variables('functionName'))]"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "dotnet"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightName')), '2015-05-01').InstrumentationKey]"
                    },
                    {
                      "name": "WEBSITE_RUN_FROM_PACKAGE",
                      "value": "[variables('functionZipBinary')]"
                    },
                    {
                      "name": "IOT_HUB_RESOURCE_ID",
                      "value": "[resourceId('Microsoft.Devices/IotHubs', parameters('iotHubName'))]"
                    },
                    {
                      "name": "LOG_ANALYTICS_WORKSPACE_ID",
                      "value": "[if(parameters('useAzureMonitorOnEdge'), reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName')), '2022-10-01').customerId, '')]"
                    },
                    {
                      "name": "LOG_ANALYTICS_WORKSPACE_KEY",
                      "value": "[if(parameters('useAzureMonitorOnEdge'), listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName')), '2022-10-01').primarySharedKey, '')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]"
              ]
            }
          ],
          "outputs": {
            "functionName": {
              "type": "string",
              "value": "[variables('functionName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'iotHub')]",
        "[resourceId('Microsoft.Resources/deployments', 'observability')]",
        "[resourceId('Microsoft.Resources/deployments', 'redisCache')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "observability",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "prefix": {
            "value": "[parameters('uniqueSolutionPrefix')]"
          },
          "iotHubName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'iotHub')).outputs.iotHubName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "useAzureMonitorOnEdge": {
            "value": "[parameters('useAzureMonitorOnEdge')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "6177579545096383016"
            }
          },
          "parameters": {
            "prefix": {
              "type": "string"
            },
            "iotHubName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "useAzureMonitorOnEdge": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}analytics', parameters('prefix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "retentionInDays": 30,
                "sku": {
                  "name": "PerGB2018"
                },
                "workspaceCapping": {
                  "dailyQuotaGb": 10
                },
                "features": {
                  "searchVersion": 1
                }
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[format('{0}insight', parameters('prefix'))]",
              "kind": "web",
              "location": "[parameters('location')]",
              "properties": {
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}analytics', parameters('prefix')))]",
                "Application_Type": "web"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}analytics', parameters('prefix')))]"
              ]
            },
            {
              "condition": "[parameters('useAzureMonitorOnEdge')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "workbook",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "appInsightsName": {
                    "value": "[format('{0}insight', parameters('prefix'))]"
                  },
                  "iothubName": {
                    "value": "[parameters('iotHubName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "11392990702030499556"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "iothubName": {
                      "type": "string"
                    },
                    "appInsightsName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "$fxv#0": "{\r\n    \"version\": \"Notebook/1.0\",\r\n    \"items\": [\r\n      {\r\n        \"type\": 9,\r\n        \"content\": {\r\n          \"version\": \"KqlParameterItem/1.0\",\r\n          \"parameters\": [\r\n            {\r\n              \"id\": \"31596d7b-c0a9-448f-b3cc-a3a906cb9d48\",\r\n              \"version\": \"KqlParameterItem/1.0\",\r\n              \"name\": \"resourceType\",\r\n              \"type\": 7,\r\n              \"isRequired\": true,\r\n              \"isGlobal\": true,\r\n              \"value\": \"Microsoft.Devices/IotHubs\",\r\n              \"isHiddenWhenLocked\": true,\r\n              \"typeSettings\": {\r\n                \"additionalResourceOptions\": [],\r\n                \"showDefault\": false\r\n              },\r\n              \"jsonData\": \"[[\\\"Microsoft.Devices/IotHubs\\\"]\",\r\n              \"defaultValue\": \"value::1\"\r\n            },\r\n            {\r\n              \"id\": \"bebd5be4-3d61-45ed-9f07-b9ae091e1ccb\",\r\n              \"version\": \"KqlParameterItem/1.0\",\r\n              \"name\": \"resource\",\r\n              \"type\": 5,\r\n              \"isRequired\": true,\r\n              \"isHiddenWhenLocked\": true,\r\n              \"typeSettings\": {\r\n                \"resourceTypeFilter\": {\r\n                  \"microsoft.devices/iothubs\": true\r\n                },\r\n                \"additionalResourceOptions\": [\"value::1\"],\r\n                \"showDefault\": false\r\n              },\r\n              \"defaultValue\": \"value::1\"\r\n            },\r\n            {\r\n              \"id\": \"d062cb40-2eed-4917-ab42-8f271db98312\",\r\n              \"version\": \"KqlParameterItem/1.0\",\r\n              \"name\": \"InsightsMetricsExists\",\r\n              \"type\": 1,\r\n              \"query\": \"let hasNonEmptyTable = (T:string) \\n{ \\n   toscalar( union isfuzzy=true ( table(T) | count as Count ), (print Count=0) | summarize sum(Count) ) > 0\\n};\\nlet TableName = 'InsightsMetrics';\\nprint IsPresent=iif(hasNonEmptyTable(TableName), \\\"yes\\\", \\\"no\\\")\",\r\n              \"crossComponentResources\": [\"{resource}\"],\r\n              \"isHiddenWhenLocked\": true,\r\n              \"timeContext\": {\r\n                \"durationMs\": 259200000\r\n              },\r\n              \"queryType\": 0,\r\n              \"resourceType\": \"{resourceType}\"\r\n            },\r\n            {\r\n              \"id\": \"36a641eb-587a-40c0-b491-b7b2f85eb0c0\",\r\n              \"version\": \"KqlParameterItem/1.0\",\r\n              \"name\": \"mainAction\",\r\n              \"type\": 1,\r\n              \"isGlobal\": true,\r\n              \"value\": \"devicelist\",\r\n              \"isHiddenWhenLocked\": true\r\n            },\r\n            {\r\n              \"id\": \"4ea30d03-74c2-4b08-bf00-f3c0a4c57f13\",\r\n              \"version\": \"KqlParameterItem/1.0\",\r\n              \"name\": \"alertResources\",\r\n              \"type\": 5,\r\n              \"isRequired\": true,\r\n              \"multiSelect\": true,\r\n              \"quote\": \"'\",\r\n              \"delimiter\": \",\",\r\n              \"typeSettings\": {\r\n                \"resourceTypeFilter\": {\r\n                  \"microsoft.devices/iothubs\": true,\r\n                  \"microsoft.insights/components\": true\r\n                },\r\n                \"additionalResourceOptions\": [\"value::all\"],\r\n                \"showDefault\": false\r\n              },\r\n              \"defaultValue\": \"value::all\"\r\n            },\r\n            {\r\n              \"id\": \"6f896f81-18dc-4307-98f3-77927af019af\",\r\n              \"version\": \"KqlParameterItem/1.0\",\r\n              \"name\": \"appInsightsResourceId\",\r\n              \"type\": 5,\r\n              \"isRequired\": true,\r\n              \"multiSelect\": true,\r\n              \"quote\": \"'\",\r\n              \"delimiter\": \",\",\r\n              \"typeSettings\": {\r\n                \"resourceTypeFilter\": {\r\n                  \"microsoft.insights/components\": true\r\n                },\r\n                \"additionalResourceOptions\": [\"value::all\"]\r\n              },\r\n              \"defaultValue\": \"value::all\"\r\n            },\r\n            {\r\n              \"id\": \"dcd93c30-5162-4e48-bb6a-f347e466e552\",\r\n              \"version\": \"KqlParameterItem/1.0\",\r\n              \"name\": \"Subscription\",\r\n              \"type\": 6,\r\n              \"isRequired\": true,\r\n              \"multiSelect\": true,\r\n              \"quote\": \"'\",\r\n              \"delimiter\": \",\",\r\n              \"typeSettings\": {\r\n                \"additionalResourceOptions\": [\"value::all\"],\r\n                \"showDefault\": false\r\n              },\r\n              \"jsonData\": \"[\\\"{{subscriptionResourceId}}\\\"]')]\",\r\n              \"defaultValue\": \"value::all\"\r\n            }\r\n          ],\r\n          \"style\": \"pills\",\r\n          \"queryType\": 0,\r\n          \"resourceType\": \"microsoft.insights/components\"\r\n        },\r\n        \"conditionalVisibility\": {\r\n          \"parameterName\": \"neverset\",\r\n          \"comparison\": \"isNotEqualTo\"\r\n        },\r\n        \"name\": \"parameters - 5\"\r\n      },\r\n      {\r\n        \"type\": 9,\r\n        \"content\": {\r\n          \"version\": \"KqlParameterItem/1.0\",\r\n          \"crossComponentResources\": [\"{appInsightsResourceId}\"],\r\n          \"parameters\": [\r\n            {\r\n              \"id\": \"1b4b2d2e-4f2e-4881-903d-f307d6958a1c\",\r\n              \"version\": \"KqlParameterItem/1.0\",\r\n              \"name\": \"timeRange\",\r\n              \"label\": \"Time range\",\r\n              \"type\": 4,\r\n              \"isRequired\": true,\r\n              \"isGlobal\": true,\r\n              \"value\": {\r\n                \"durationMs\": 14400000\r\n              },\r\n              \"typeSettings\": {\r\n                \"selectableValues\": [\r\n                  {\r\n                    \"durationMs\": 1800000\r\n                  },\r\n                  {\r\n                    \"durationMs\": 3600000\r\n                  },\r\n                  {\r\n                    \"durationMs\": 14400000\r\n                  },\r\n                  {\r\n                    \"durationMs\": 43200000\r\n                  },\r\n                  {\r\n                    \"durationMs\": 86400000\r\n                  },\r\n                  {\r\n                    \"durationMs\": 172800000\r\n                  },\r\n                  {\r\n                    \"durationMs\": 259200000\r\n                  },\r\n                  {\r\n                    \"durationMs\": 604800000\r\n                  },\r\n                  {\r\n                    \"durationMs\": 1209600000\r\n                  },\r\n                  {\r\n                    \"durationMs\": 2592000000\r\n                  }\r\n                ],\r\n                \"allowCustom\": true\r\n              }\r\n            }\r\n          ],\r\n          \"style\": \"pills\",\r\n          \"queryType\": 0,\r\n          \"resourceType\": \"{resourceType}\"\r\n        },\r\n        \"customWidth\": \"30\",\r\n        \"conditionalVisibility\": {\r\n          \"parameterName\": \"InsightsMetricsExists\",\r\n          \"comparison\": \"isEqualTo\",\r\n          \"value\": \"yes\"\r\n        },\r\n        \"name\": \"Time Range\"\r\n      },\r\n      {\r\n        \"type\": 12,\r\n        \"content\": {\r\n          \"version\": \"NotebookGroup/1.0\",\r\n          \"groupType\": \"editable\",\r\n          \"title\": \"Overview - Failure Indicators\",\r\n          \"items\": [\r\n            {\r\n              \"type\": 3,\r\n              \"content\": {\r\n                \"version\": \"KqlItem/1.0\",\r\n                \"query\": \"let connectivityLost = customMetrics\\r\\n| where name == \\\"StationConnectivityLost\\\"\\r\\n| project name, valueSum\\r\\n| summarize Count = sum(valueSum) by name\\r\\n| take 1;\\r\\ncustomMetrics\\r\\n| where name == \\\"StationConnectivityLost\\\"\\r\\n| make-series Trend = avg(value) default = 0 on timestamp from {timeRange:start} to {timeRange:end} step {timeRange:grain} by name\\r\\n| join (connectivityLost) on name\\r\\n| project-away name, timestamp\",\r\n                \"size\": 4,\r\n                \"noDataMessage\": \"No connections lost\",\r\n                \"noDataMessageStyle\": 3,\r\n                \"timeContext\": {\r\n                  \"durationMs\": 14400000\r\n                },\r\n                \"timeContextFromParameter\": \"timeRange\",\r\n                \"queryType\": 0,\r\n                \"resourceType\": \"microsoft.insights/components\",\r\n                \"crossComponentResources\": [\"{appInsightsResourceId}\"],\r\n                \"visualization\": \"tiles\",\r\n                \"tileSettings\": {\r\n                  \"titleContent\": {\r\n                    \"columnMatch\": \"name1\",\r\n                    \"formatter\": 1\r\n                  },\r\n                  \"leftContent\": {\r\n                    \"columnMatch\": \"Count\",\r\n                    \"formatter\": 12,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"hotCold\"\r\n                    },\r\n                    \"numberFormat\": {\r\n                      \"unit\": 17,\r\n                      \"options\": {\r\n                        \"style\": \"decimal\",\r\n                        \"maximumFractionDigits\": 0,\r\n                        \"maximumSignificantDigits\": 3\r\n                      }\r\n                    }\r\n                  },\r\n                  \"secondaryContent\": {\r\n                    \"columnMatch\": \"Trend\",\r\n                    \"formatter\": 9,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"red\"\r\n                    }\r\n                  },\r\n                  \"showBorder\": false\r\n                }\r\n              },\r\n              \"customWidth\": \"15\",\r\n              \"name\": \"Station Connectivity Lost\"\r\n            },\r\n            {\r\n              \"type\": 3,\r\n              \"content\": {\r\n                \"version\": \"KqlItem/1.0\",\r\n                \"query\": \"let receiveWindowMisses = customMetrics\\r\\n| where name == \\\"ReceiveWindowMisses\\\"\\r\\n| order by timestamp desc\\r\\n| project name, valueSum\\r\\n| summarize Sum = sum(valueSum) by name\\r\\n| take 1;\\r\\ncustomMetrics\\r\\n| where name == \\\"ReceiveWindowMisses\\\"\\r\\n| make-series Trend = sum(valueSum) default = 0 on timestamp from {timeRange:start} to {timeRange:end} step {timeRange:grain} by name\\r\\n| join (receiveWindowMisses) on name\\r\\n| project-away name, timestamp\",\r\n                \"size\": 4,\r\n                \"noDataMessage\": \"No receive windows missed\",\r\n                \"noDataMessageStyle\": 3,\r\n                \"timeContext\": {\r\n                  \"durationMs\": 14400000\r\n                },\r\n                \"timeContextFromParameter\": \"timeRange\",\r\n                \"queryType\": 0,\r\n                \"resourceType\": \"microsoft.insights/components\",\r\n                \"crossComponentResources\": [\"{appInsightsResourceId}\"],\r\n                \"visualization\": \"tiles\",\r\n                \"tileSettings\": {\r\n                  \"titleContent\": {\r\n                    \"columnMatch\": \"name1\"\r\n                  },\r\n                  \"leftContent\": {\r\n                    \"columnMatch\": \"Sum\",\r\n                    \"formatter\": 12,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"hotCold\"\r\n                    }\r\n                  },\r\n                  \"secondaryContent\": {\r\n                    \"columnMatch\": \"Trend\",\r\n                    \"formatter\": 9,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"red\"\r\n                    }\r\n                  },\r\n                  \"showBorder\": false,\r\n                  \"size\": \"auto\"\r\n                }\r\n              },\r\n              \"customWidth\": \"15\",\r\n              \"name\": \"Receive Windows\"\r\n            },\r\n            {\r\n              \"type\": 3,\r\n              \"content\": {\r\n                \"version\": \"KqlItem/1.0\",\r\n                \"query\": \"let unhandledExceptions = customMetrics\\r\\n| where name == \\\"UnhandledExceptions\\\"\\r\\n| project name, valueSum, exceptionKeyword = \\\"Exception\\\"\\r\\n| summarize Count = sum(valueSum) by name, exceptionKeyword\\r\\n| take 1;\\r\\ncustomMetrics\\r\\n| where name == \\\"UnhandledExceptions\\\"\\r\\n| make-series Trend = avg(value) default = 0 on timestamp from {timeRange:start} to {timeRange:end} step {timeRange:grain} by name\\r\\n| join (unhandledExceptions) on name\\r\\n| project-away name, timestamp\",\r\n                \"size\": 4,\r\n                \"noDataMessage\": \"No unhandled exceptions detected\",\r\n                \"noDataMessageStyle\": 3,\r\n                \"timeContext\": {\r\n                  \"durationMs\": 14400000\r\n                },\r\n                \"timeContextFromParameter\": \"timeRange\",\r\n                \"queryType\": 0,\r\n                \"resourceType\": \"microsoft.insights/components\",\r\n                \"crossComponentResources\": [\"{appInsightsResourceId}\"],\r\n                \"visualization\": \"tiles\",\r\n                \"tileSettings\": {\r\n                  \"titleContent\": {\r\n                    \"columnMatch\": \"name1\",\r\n                    \"formatter\": 1,\r\n                    \"formatOptions\": {\r\n                      \"linkColumn\": \"exceptionKeyword\",\r\n                      \"linkTarget\": \"Search\"\r\n                    }\r\n                  },\r\n                  \"leftContent\": {\r\n                    \"columnMatch\": \"Count\",\r\n                    \"formatter\": 12,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"hotCold\"\r\n                    },\r\n                    \"numberFormat\": {\r\n                      \"unit\": 17,\r\n                      \"options\": {\r\n                        \"style\": \"decimal\",\r\n                        \"maximumFractionDigits\": 2,\r\n                        \"maximumSignificantDigits\": 3\r\n                      }\r\n                    }\r\n                  },\r\n                  \"secondaryContent\": {\r\n                    \"columnMatch\": \"Trend\",\r\n                    \"formatter\": 9,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"red\"\r\n                    }\r\n                  },\r\n                  \"showBorder\": false\r\n                }\r\n              },\r\n              \"customWidth\": \"15\",\r\n              \"name\": \"Unhandled Exceptions\"\r\n            },\r\n            {\r\n              \"type\": 3,\r\n              \"content\": {\r\n                \"version\": \"KqlItem/1.0\",\r\n                \"query\": \"let c2dmessagesTooLong = customMetrics\\r\\n| where name == \\\"C2DMessageTooLong\\\"\\r\\n| project name, valueSum\\r\\n| summarize Count = sum(valueSum) by name\\r\\n| take 1;\\r\\ncustomMetrics\\r\\n| where name == \\\"C2DMessageTooLong\\\"\\r\\n| make-series Trend = avg(value) default = 0 on timestamp from {timeRange:start} to {timeRange:end} step {timeRange:grain} by name\\r\\n| join (c2dmessagesTooLong) on name\\r\\n| project-away name, timestamp\",\r\n                \"size\": 4,\r\n                \"noDataMessage\": \"No C2D messages that were too long detected\",\r\n                \"noDataMessageStyle\": 3,\r\n                \"timeContext\": {\r\n                  \"durationMs\": 14400000\r\n                },\r\n                \"timeContextFromParameter\": \"timeRange\",\r\n                \"queryType\": 0,\r\n                \"resourceType\": \"microsoft.insights/components\",\r\n                \"crossComponentResources\": [\"{appInsightsResourceId}\"],\r\n                \"visualization\": \"tiles\",\r\n                \"tileSettings\": {\r\n                  \"titleContent\": {\r\n                    \"columnMatch\": \"name1\"\r\n                  },\r\n                  \"leftContent\": {\r\n                    \"columnMatch\": \"Sum\",\r\n                    \"formatter\": 12,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"hotCold\"\r\n                    }\r\n                  },\r\n                  \"secondaryContent\": {\r\n                    \"columnMatch\": \"Trend\",\r\n                    \"formatter\": 9,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"red\"\r\n                    }\r\n                  },\r\n                  \"showBorder\": false,\r\n                  \"size\": \"auto\"\r\n                }\r\n              },\r\n              \"customWidth\": \"15\",\r\n              \"name\": \"C2DMessageTooLong\"\r\n            }\r\n          ]\r\n        },\r\n        \"name\": \"Overview - Failure Indicators\"\r\n      },\r\n      {\r\n        \"type\": 12,\r\n        \"content\": {\r\n          \"version\": \"NotebookGroup/1.0\",\r\n          \"groupType\": \"editable\",\r\n          \"title\": \"Overview - Performance Indicators\",\r\n          \"items\": [\r\n            {\r\n              \"type\": 3,\r\n              \"content\": {\r\n                \"version\": \"KqlItem/1.0\",\r\n                \"query\": \"let activeConnections = customMetrics\\r\\n| where name == \\\"ActiveStationConnections\\\"\\r\\n| order by timestamp desc\\r\\n| project value, name\\r\\n| take 1;\\r\\ncustomMetrics\\r\\n| where name == \\\"ActiveStationConnections\\\"\\r\\n| make-series Trend = avg(value) default = 0 on timestamp from {timeRange:start} to {timeRange:end} step {timeRange:grain} by name\\r\\n| join (activeConnections) on name\\r\\n| project-away name, timestamp\\r\\n\\r\\n\\r\\n\",\r\n                \"size\": 4,\r\n                \"timeContext\": {\r\n                  \"durationMs\": 14400000\r\n                },\r\n                \"timeContextFromParameter\": \"timeRange\",\r\n                \"queryType\": 0,\r\n                \"resourceType\": \"microsoft.insights/components\",\r\n                \"crossComponentResources\": [\"{appInsightsResourceId}\"],\r\n                \"visualization\": \"tiles\",\r\n                \"tileSettings\": {\r\n                  \"titleContent\": {\r\n                    \"columnMatch\": \"name1\",\r\n                    \"formatter\": 1\r\n                  },\r\n                  \"leftContent\": {\r\n                    \"columnMatch\": \"value\",\r\n                    \"formatter\": 12,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"auto\"\r\n                    },\r\n                    \"numberFormat\": {\r\n                      \"unit\": 17,\r\n                      \"options\": {\r\n                        \"style\": \"decimal\",\r\n                        \"useGrouping\": false,\r\n                        \"maximumFractionDigits\": 0,\r\n                        \"maximumSignificantDigits\": 3\r\n                      }\r\n                    }\r\n                  },\r\n                  \"secondaryContent\": {\r\n                    \"columnMatch\": \"Trend\",\r\n                    \"formatter\": 9,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"blue\"\r\n                    }\r\n                  },\r\n                  \"showBorder\": false,\r\n                  \"size\": \"auto\"\r\n                }\r\n              },\r\n              \"customWidth\": \"15\",\r\n              \"name\": \"Active Station Connections\"\r\n            },\r\n            {\r\n              \"type\": 3,\r\n              \"content\": {\r\n                \"version\": \"KqlItem/1.0\",\r\n                \"query\": \"let deliveryLatency = customMetrics\\r\\n| where name == \\\"D2CMessageDeliveryLatency\\\"\\r\\n| order by timestamp desc\\r\\n| take 1;\\r\\ncustomMetrics\\r\\n| where name == \\\"D2CMessageDeliveryLatency\\\"\\r\\n| make-series Trend = avg(value) default = 0 on timestamp from {timeRange:start} to {timeRange:end} step {timeRange:grain} by name\\r\\n| join (deliveryLatency) on name\\r\\n| project-away name, timestamp\",\r\n                \"size\": 4,\r\n                \"timeContext\": {\r\n                  \"durationMs\": 14400000\r\n                },\r\n                \"timeContextFromParameter\": \"timeRange\",\r\n                \"queryType\": 0,\r\n                \"resourceType\": \"microsoft.insights/components\",\r\n                \"crossComponentResources\": [\"{appInsightsResourceId}\"],\r\n                \"visualization\": \"tiles\",\r\n                \"tileSettings\": {\r\n                  \"titleContent\": {\r\n                    \"columnMatch\": \"name1\",\r\n                    \"formatter\": 1\r\n                  },\r\n                  \"leftContent\": {\r\n                    \"columnMatch\": \"value\",\r\n                    \"formatter\": 12,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"auto\"\r\n                    },\r\n                    \"numberFormat\": {\r\n                      \"unit\": 23,\r\n                      \"options\": {\r\n                        \"style\": \"decimal\",\r\n                        \"maximumFractionDigits\": 2,\r\n                        \"maximumSignificantDigits\": 3\r\n                      }\r\n                    }\r\n                  },\r\n                  \"secondaryContent\": {\r\n                    \"columnMatch\": \"Trend\",\r\n                    \"formatter\": 9,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"blue\"\r\n                    }\r\n                  },\r\n                  \"showBorder\": false,\r\n                  \"size\": \"auto\"\r\n                }\r\n              },\r\n              \"customWidth\": \"15\",\r\n              \"name\": \"Delivery Latencies\"\r\n            },\r\n            {\r\n              \"type\": 3,\r\n              \"content\": {\r\n                \"version\": \"KqlItem/1.0\",\r\n                \"query\": \"let joinRequests = customMetrics\\r\\n| where name == \\\"JoinRequests\\\"\\r\\n| order by timestamp desc\\r\\n| project name, valueSum\\r\\n| summarize JoinRequestSum = sum(valueSum) by name\\r\\n| take 1;\\r\\ncustomMetrics\\r\\n| where name == \\\"JoinRequests\\\"\\r\\n| make-series Trend = sum(valueSum) default = 0 on timestamp from {timeRange:start} to {timeRange:end} step {timeRange:grain} by name\\r\\n| join (joinRequests) on name\\r\\n| project-away name, timestamp\",\r\n                \"size\": 4,\r\n                \"timeContext\": {\r\n                  \"durationMs\": 14400000\r\n                },\r\n                \"timeContextFromParameter\": \"timeRange\",\r\n                \"queryType\": 0,\r\n                \"resourceType\": \"microsoft.insights/components\",\r\n                \"crossComponentResources\": [\"{appInsightsResourceId}\"],\r\n                \"visualization\": \"tiles\",\r\n                \"tileSettings\": {\r\n                  \"titleContent\": {\r\n                    \"columnMatch\": \"name1\",\r\n                    \"formatter\": 1\r\n                  },\r\n                  \"leftContent\": {\r\n                    \"columnMatch\": \"JoinRequestSum\",\r\n                    \"formatter\": 12,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"auto\"\r\n                    },\r\n                    \"numberFormat\": {\r\n                      \"unit\": 17,\r\n                      \"options\": {\r\n                        \"style\": \"decimal\",\r\n                        \"maximumFractionDigits\": 2,\r\n                        \"maximumSignificantDigits\": 3\r\n                      }\r\n                    }\r\n                  },\r\n                  \"secondaryContent\": {\r\n                    \"columnMatch\": \"Trend\",\r\n                    \"formatter\": 9,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"blue\"\r\n                    }\r\n                  },\r\n                  \"showBorder\": false,\r\n                  \"size\": \"auto\"\r\n                }\r\n              },\r\n              \"customWidth\": \"15\",\r\n              \"name\": \"Join requests\"\r\n            },\r\n            {\r\n              \"type\": 3,\r\n              \"content\": {\r\n                \"version\": \"KqlItem/1.0\",\r\n                \"query\": \"let messageSizes = customMetrics\\r\\n| where name == \\\"D2CMessageSize\\\"\\r\\n| order by timestamp desc\\r\\n| summarize D2CMessageSize = avg(value) by name;\\r\\ncustomMetrics\\r\\n| where name == \\\"D2CMessageSize\\\"\\r\\n| make-series Hist = sum(valueSum) default = 0 on value from 5.0 to 250.0 step 5.0 by name\\r\\n| join (messageSizes) on name\",\r\n                \"size\": 4,\r\n                \"timeContext\": {\r\n                  \"durationMs\": 14400000\r\n                },\r\n                \"timeContextFromParameter\": \"timeRange\",\r\n                \"queryType\": 0,\r\n                \"resourceType\": \"microsoft.insights/components\",\r\n                \"crossComponentResources\": [\"{appInsightsResourceId}\"],\r\n                \"visualization\": \"tiles\",\r\n                \"tileSettings\": {\r\n                  \"titleContent\": {\r\n                    \"columnMatch\": \"name1\",\r\n                    \"formatter\": 1\r\n                  },\r\n                  \"leftContent\": {\r\n                    \"columnMatch\": \"D2CMessageSize\",\r\n                    \"formatter\": 12,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"auto\"\r\n                    },\r\n                    \"numberFormat\": {\r\n                      \"unit\": 2,\r\n                      \"options\": {\r\n                        \"style\": \"decimal\",\r\n                        \"maximumFractionDigits\": 2,\r\n                        \"maximumSignificantDigits\": 3\r\n                      }\r\n                    }\r\n                  },\r\n                  \"secondaryContent\": {\r\n                    \"columnMatch\": \"Hist\",\r\n                    \"formatter\": 10,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"blue\"\r\n                    }\r\n                  },\r\n                  \"showBorder\": false,\r\n                  \"size\": \"auto\"\r\n                }\r\n              },\r\n              \"customWidth\": \"15\",\r\n              \"name\": \"D2C message size\"\r\n            },\r\n            {\r\n              \"type\": 3,\r\n              \"content\": {\r\n                \"version\": \"KqlItem/1.0\",\r\n                \"query\": \"let sum = customMetrics\\r\\n| where name == \\\"D2CMessagesReceived\\\"\\r\\n| order by timestamp desc\\r\\n| project name, valueSum\\r\\n| summarize Sum = sum(valueSum) by name\\r\\n| take 1;\\r\\ncustomMetrics\\r\\n| where name == \\\"D2CMessagesReceived\\\"\\r\\n| make-series Trend = sum(valueSum) default = 0 on timestamp from {timeRange:start} to {timeRange:end} step {timeRange:grain} by name\\r\\n| join (sum) on name\\r\\n| project-away name, timestamp\",\r\n                \"size\": 4,\r\n                \"timeContext\": {\r\n                  \"durationMs\": 14400000\r\n                },\r\n                \"timeContextFromParameter\": \"timeRange\",\r\n                \"queryType\": 0,\r\n                \"resourceType\": \"microsoft.insights/components\",\r\n                \"crossComponentResources\": [\"{appInsightsResourceId}\"],\r\n                \"visualization\": \"tiles\",\r\n                \"tileSettings\": {\r\n                  \"titleContent\": {\r\n                    \"columnMatch\": \"name1\",\r\n                    \"formatter\": 1\r\n                  },\r\n                  \"leftContent\": {\r\n                    \"columnMatch\": \"Sum\",\r\n                    \"formatter\": 12,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"auto\"\r\n                    },\r\n                    \"numberFormat\": {\r\n                      \"unit\": 17,\r\n                      \"options\": {\r\n                        \"style\": \"decimal\",\r\n                        \"maximumFractionDigits\": 2,\r\n                        \"maximumSignificantDigits\": 3\r\n                      }\r\n                    }\r\n                  },\r\n                  \"secondaryContent\": {\r\n                    \"columnMatch\": \"Trend\",\r\n                    \"formatter\": 10,\r\n                    \"formatOptions\": {\r\n                      \"palette\": \"blue\"\r\n                    }\r\n                  },\r\n                  \"showBorder\": false\r\n                }\r\n              },\r\n              \"customWidth\": \"15\",\r\n              \"name\": \"D2CMessagesReceived\"\r\n            }\r\n          ]\r\n        },\r\n        \"name\": \"Overview - Performance Indicators\"\r\n      },\r\n      {\r\n        \"type\": 12,\r\n        \"content\": {\r\n          \"version\": \"NotebookGroup/1.0\",\r\n          \"groupType\": \"editable\",\r\n          \"title\": \"Dependencies\",\r\n          \"items\": [\r\n            {\r\n              \"type\": 3,\r\n              \"content\": {\r\n                \"version\": \"KqlItem/1.0\",\r\n                \"query\": \"let rawData = dependencies\\r\\n| project duration, name, type, timestamp, EndpointWithoutDeviceId = extract(\\\"(.*)/[0-9a-zA-Z]{16}$\\\", 1, name)\\r\\n| project duration, type, timestamp, Endpoint = iff(isempty(EndpointWithoutDeviceId), name, EndpointWithoutDeviceId);\\r\\nlet history = rawData\\r\\n| make-series avg(duration) default=0 on timestamp from {timeRange:start} to {timeRange:end} step {timeRange:grain} by Endpoint\\r\\n| project-away timestamp;\\r\\nrawData\\r\\n| summarize Mean = avg(duration), (p95) = percentiles(duration, 95), Requests = count() by type, Endpoint\\r\\n| join (history) on Endpoint\\r\\n| order by Requests desc\",\r\n                \"size\": 3,\r\n                \"timeContext\": {\r\n                  \"durationMs\": 14400000\r\n                },\r\n                \"timeContextFromParameter\": \"timeRange\",\r\n                \"queryType\": 0,\r\n                \"resourceType\": \"microsoft.insights/components\",\r\n                \"crossComponentResources\": [\"{appInsightsResourceId}\"],\r\n                \"gridSettings\": {\r\n                  \"formatters\": [\r\n                    {\r\n                      \"columnMatch\": \"Mean\",\r\n                      \"formatter\": 0,\r\n                      \"numberFormat\": {\r\n                        \"unit\": 23,\r\n                        \"options\": {\r\n                          \"style\": \"decimal\",\r\n                          \"minimumSignificantDigits\": 3,\r\n                          \"maximumSignificantDigits\": 3\r\n                        }\r\n                      }\r\n                    },\r\n                    {\r\n                      \"columnMatch\": \"p95\",\r\n                      \"formatter\": 0,\r\n                      \"numberFormat\": {\r\n                        \"unit\": 23,\r\n                        \"options\": {\r\n                          \"style\": \"decimal\",\r\n                          \"minimumSignificantDigits\": 3,\r\n                          \"maximumSignificantDigits\": 3\r\n                        }\r\n                      }\r\n                    },\r\n                    {\r\n                      \"columnMatch\": \"Requests\",\r\n                      \"formatter\": 0,\r\n                      \"numberFormat\": {\r\n                        \"unit\": 17,\r\n                        \"options\": {\r\n                          \"style\": \"decimal\"\r\n                        }\r\n                      }\r\n                    },\r\n                    {\r\n                      \"columnMatch\": \"Endpoint1\",\r\n                      \"formatter\": 5\r\n                    },\r\n                    {\r\n                      \"columnMatch\": \"avg_duration\",\r\n                      \"formatter\": 10,\r\n                      \"formatOptions\": {\r\n                        \"palette\": \"blue\"\r\n                      },\r\n                      \"numberFormat\": {\r\n                        \"unit\": 23,\r\n                        \"options\": {\r\n                          \"style\": \"decimal\"\r\n                        }\r\n                      }\r\n                    },\r\n                    {\r\n                      \"columnMatch\": \"Median\",\r\n                      \"formatter\": 0,\r\n                      \"numberFormat\": {\r\n                        \"unit\": 23,\r\n                        \"options\": {\r\n                          \"style\": \"decimal\",\r\n                          \"minimumSignificantDigits\": 3,\r\n                          \"maximumSignificantDigits\": 3\r\n                        }\r\n                      }\r\n                    },\r\n                    {\r\n                      \"columnMatch\": \"p80\",\r\n                      \"formatter\": 0,\r\n                      \"numberFormat\": {\r\n                        \"unit\": 23,\r\n                        \"options\": {\r\n                          \"style\": \"decimal\",\r\n                          \"minimumSignificantDigits\": 3,\r\n                          \"maximumSignificantDigits\": 3\r\n                        }\r\n                      }\r\n                    }\r\n                  ],\r\n                  \"labelSettings\": [\r\n                    {\r\n                      \"columnId\": \"type\",\r\n                      \"label\": \"Type\"\r\n                    },\r\n                    {\r\n                      \"columnId\": \"avg_duration\",\r\n                      \"label\": \"Average Duration (history)\"\r\n                    }\r\n                  ]\r\n                }\r\n              },\r\n              \"name\": \"Dependency durations\"\r\n            }\r\n          ]\r\n        },\r\n        \"name\": \"Dependencies\"\r\n      },\r\n      {\r\n        \"type\": 12,\r\n        \"content\": {\r\n          \"version\": \"NotebookGroup/1.0\",\r\n          \"groupType\": \"editable\",\r\n          \"title\": \"Fleet Overview\",\r\n          \"items\": [\r\n            {\r\n              \"type\": 11,\r\n              \"content\": {\r\n                \"version\": \"LinkItem/1.0\",\r\n                \"style\": \"tabs\",\r\n                \"links\": [\r\n                  {\r\n                    \"id\": \"9ba0a0e8-584b-421a-85e6-96c89eda5a17\",\r\n                    \"cellValue\": \"mainAction\",\r\n                    \"linkTarget\": \"parameter\",\r\n                    \"linkLabel\": \"Devices\",\r\n                    \"subTarget\": \"devicelist\",\r\n                    \"style\": \"link\"\r\n                  },\r\n                  {\r\n                    \"id\": \"3b8d77da-20d0-499a-b62d-25f5c6a88a55\",\r\n                    \"cellValue\": \"mainAction\",\r\n                    \"linkTarget\": \"parameter\",\r\n                    \"linkLabel\": \"Alerts\",\r\n                    \"subTarget\": \"alerts\",\r\n                    \"style\": \"link\"\r\n                  }\r\n                ]\r\n              },\r\n              \"customWidth\": \"25\",\r\n              \"conditionalVisibility\": {\r\n                \"parameterName\": \"InsightsMetricsExists\",\r\n                \"comparison\": \"isEqualTo\",\r\n                \"value\": \"yes\"\r\n              },\r\n              \"name\": \"links - 8 - Copy\"\r\n            },\r\n            {\r\n              \"type\": 12,\r\n              \"content\": {\r\n                \"version\": \"NotebookGroup/1.0\",\r\n                \"groupType\": \"template\",\r\n                \"loadFromTemplateId\": \"Community-Workbooks/IoTHub/IoT Edge\",\r\n                \"items\": [],\r\n                \"exportParameters\": true\r\n              },\r\n              \"conditionalVisibilities\": [\r\n                {\r\n                  \"parameterName\": \"InsightsMetricsExists\",\r\n                  \"comparison\": \"isEqualTo\",\r\n                  \"value\": \"yes\"\r\n                },\r\n                {\r\n                  \"parameterName\": \"mainAction\",\r\n                  \"comparison\": \"isEqualTo\",\r\n                  \"value\": \"devicelist\"\r\n                }\r\n              ],\r\n              \"name\": \"device-group\",\r\n              \"styleSettings\": {\r\n                \"showBorder\": true\r\n              }\r\n            },\r\n            {\r\n              \"type\": 12,\r\n              \"content\": {\r\n                \"version\": \"NotebookGroup/1.0\",\r\n                \"groupType\": \"editable\",\r\n                \"items\": [\r\n                  {\r\n                    \"type\": 9,\r\n                    \"content\": {\r\n                      \"version\": \"KqlParameterItem/1.0\",\r\n                      \"parameters\": [\r\n                        {\r\n                          \"id\": \"bd6d6075-dc8f-43d3-829f-7e2245a3eb21\",\r\n                          \"version\": \"KqlParameterItem/1.0\",\r\n                          \"name\": \"State\",\r\n                          \"type\": 2,\r\n                          \"isRequired\": true,\r\n                          \"multiSelect\": true,\r\n                          \"quote\": \"'\",\r\n                          \"delimiter\": \",\",\r\n                          \"query\": \"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"[ \\\\r\\\\n    {\\\\\\\"id\\\\\\\":\\\\\\\"New\\\\\\\", \\\\\\\"label\\\\\\\": \\\\\\\"New\\\\\\\"},\\\\r\\\\n    {\\\\\\\"id\\\\\\\":\\\\\\\"Acknowledged\\\\\\\", \\\\\\\"label\\\\\\\": \\\\\\\"Acknowledged\\\\\\\"},\\\\r\\\\n    {\\\\\\\"id\\\\\\\":\\\\\\\"Closed\\\\\\\", \\\\\\\"label\\\\\\\": \\\\\\\"Closed\\\\\\\"}\\\\r\\\\n]\\\",\\\"transformers\\\":null}\",\r\n                          \"crossComponentResources\": [\"{Subscription}\"],\r\n                          \"value\": [\"value::all\"],\r\n                          \"typeSettings\": {\r\n                            \"additionalResourceOptions\": [\"value::all\"],\r\n                            \"selectAllValue\": \"*\",\r\n                            \"showDefault\": false\r\n                          },\r\n                          \"queryType\": 8\r\n                        }\r\n                      ],\r\n                      \"style\": \"above\",\r\n                      \"queryType\": 0,\r\n                      \"resourceType\": \"microsoft.insights/components\"\r\n                    },\r\n                    \"customWidth\": \"0\",\r\n                    \"name\": \"parameters\",\r\n                    \"styleSettings\": {\r\n                      \"margin\": \"10px 0px 0px 10px\"\r\n                    }\r\n                  },\r\n                  {\r\n                    \"type\": 12,\r\n                    \"content\": {\r\n                      \"version\": \"NotebookGroup/1.0\",\r\n                      \"groupType\": \"editable\",\r\n                      \"items\": [\r\n                        {\r\n                          \"type\": 12,\r\n                          \"content\": {\r\n                            \"version\": \"NotebookGroup/1.0\",\r\n                            \"groupType\": \"editable\",\r\n                            \"items\": [\r\n                              {\r\n                                \"type\": 3,\r\n                                \"content\": {\r\n                                  \"version\": \"KqlItem/1.0\",\r\n                                  \"query\": \"AlertsManagementResources | where type =~ 'microsoft.alertsmanagement/alerts'\\r\\n| where todatetime(properties.essentials.startDateTime) {timeRange}\\r\\n| where \\\"*\\\" in ({alertResources}) or properties.essentials.targetResource in~ ({alertResources})\\r\\n| extend State=tostring(properties.essentials.alertState)\\r\\n| where \\\"*\\\" in ({State}) or State in ({State})\\r\\n| summarize Count=count(), New=countif(State==\\\"New\\\"), \\r\\nAcknowledged=countif(State==\\\"Acknowledged\\\"), \\r\\nClosed=countif(State==\\\"Closed\\\") \\r\\nby Severity=tostring(properties.essentials.severity)\\r\\n| order by Severity asc\",\r\n                                  \"size\": 3,\r\n                                  \"noDataMessage\": \"No alerts found\",\r\n                                  \"noDataMessageStyle\": 3,\r\n                                  \"exportMultipleValues\": true,\r\n                                  \"exportedParameters\": [\r\n                                    {\r\n                                      \"fieldName\": \"Severity\",\r\n                                      \"parameterName\": \"Severity\",\r\n                                      \"parameterType\": 1\r\n                                    }\r\n                                  ],\r\n                                  \"queryType\": 1,\r\n                                  \"resourceType\": \"microsoft.resourcegraph/resources\",\r\n                                  \"crossComponentResources\": [\r\n                                    \"{Subscription}\"\r\n                                  ],\r\n                                  \"visualization\": \"table\"\r\n                                },\r\n                                \"name\": \"Alerts summary\"\r\n                              }\r\n                            ],\r\n                            \"exportParameters\": true\r\n                          },\r\n                          \"conditionalVisibility\": {\r\n                            \"parameterName\": \"Subscription\",\r\n                            \"comparison\": \"isNotEqualTo\"\r\n                          },\r\n                          \"name\": \"alert-summary-group\"\r\n                        },\r\n                        {\r\n                          \"type\": 12,\r\n                          \"content\": {\r\n                            \"version\": \"NotebookGroup/1.0\",\r\n                            \"groupType\": \"editable\",\r\n                            \"items\": [\r\n                              {\r\n                                \"type\": 11,\r\n                                \"content\": {\r\n                                  \"version\": \"LinkItem/1.0\",\r\n                                  \"style\": \"tabs\",\r\n                                  \"links\": [\r\n                                    {\r\n                                      \"id\": \"b4b81349-14f3-49a1-91df-701be106b46a\",\r\n                                      \"cellValue\": \"tab\",\r\n                                      \"linkTarget\": \"parameter\",\r\n                                      \"linkLabel\": \"Alert Details\",\r\n                                      \"subTarget\": \"details\",\r\n                                      \"preText\": \"Alert Details\",\r\n                                      \"style\": \"link\"\r\n                                    },\r\n                                    {\r\n                                      \"id\": \"7e0cfa3e-5858-4016-adf1-3695c714d915\",\r\n                                      \"cellValue\": \"tab\",\r\n                                      \"linkTarget\": \"parameter\",\r\n                                      \"linkLabel\": \"Alerts by Region\",\r\n                                      \"subTarget\": \"region\",\r\n                                      \"style\": \"link\"\r\n                                    }\r\n                                  ]\r\n                                },\r\n                                \"name\": \"links - 2\"\r\n                              },\r\n                              {\r\n                                \"type\": 3,\r\n                                \"content\": {\r\n                                  \"version\": \"KqlItem/1.0\",\r\n                                  \"query\": \"AlertsManagementResources | where type =~ 'microsoft.alertsmanagement/alerts'\\r\\n| where todatetime(properties.essentials.startDateTime) {timeRange}  \\r\\n| extend Severity=tostring(properties.essentials.severity)\\r\\n| where Severity in ({Severity})\\r\\n| extend State=tostring(properties.essentials.alertState)\\r\\n| project AlertId=id, StartTime=todatetime(tostring(properties.essentials.startDateTime)), Severity, State=tostring(properties.essentials.alertState), Name=name, TargetResource = tostring(properties.essentials.targetResource), MonitorService = tostring(properties.essentials.monitorService), SignalType=tostring(properties.essentials.signalType), Description=tostring(properties.essentials.description)\\r\\n\",\r\n                                  \"size\": 3,\r\n                                  \"showExportToExcel\": true,\r\n                                  \"queryType\": 1,\r\n                                  \"resourceType\": \"microsoft.resourcegraph/resources\",\r\n                                  \"crossComponentResources\": [\r\n                                    \"{Subscription}\"\r\n                                  ],\r\n                                  \"visualization\": \"table\",\r\n                                  \"gridSettings\": {\r\n                                    \"formatters\": [\r\n                                      {\r\n                                        \"columnMatch\": \"AlertId\",\r\n                                        \"formatter\": 5\r\n                                      },\r\n                                      {\r\n                                        \"columnMatch\": \"StartTime\",\r\n                                        \"formatter\": 6\r\n                                      },\r\n                                      {\r\n                                        \"columnMatch\": \"Severity\",\r\n                                        \"formatter\": 11\r\n                                      },\r\n                                      {\r\n                                        \"columnMatch\": \"Name\",\r\n                                        \"formatter\": 1,\r\n                                        \"formatOptions\": {\r\n                                          \"linkTarget\": \"OpenBlade\",\r\n                                          \"bladeOpenContext\": {\r\n                                            \"bladeName\": \"AlertDetailsTemplateBlade\",\r\n                                            \"extensionName\": \"Microsoft_Azure_Monitoring\",\r\n                                            \"bladeParameters\": [\r\n                                              {\r\n                                                \"name\": \"alertId\",\r\n                                                \"source\": \"column\",\r\n                                                \"value\": \"AlertId\"\r\n                                              },\r\n                                              {\r\n                                                \"name\": \"alertName\",\r\n                                                \"source\": \"column\",\r\n                                                \"value\": \"Name\"\r\n                                              },\r\n                                              {\r\n                                                \"name\": \"invokedFrom\",\r\n                                                \"source\": \"static\",\r\n                                                \"value\": \"Workbooks\"\r\n                                              }\r\n                                            ]\r\n                                          }\r\n                                        },\r\n                                        \"tooltipFormat\": {\r\n                                          \"tooltip\": \"View alert details\"\r\n                                        }\r\n                                      }\r\n                                    ]\r\n                                  }\r\n                                },\r\n                                \"conditionalVisibilities\": [\r\n                                  {\r\n                                    \"parameterName\": \"Severity\",\r\n                                    \"comparison\": \"isNotEqualTo\"\r\n                                  },\r\n                                  {\r\n                                    \"parameterName\": \"tab\",\r\n                                    \"comparison\": \"isEqualTo\",\r\n                                    \"value\": \"details\"\r\n                                  }\r\n                                ],\r\n                                \"name\": \"Alert details\"\r\n                              },\r\n                              {\r\n                                \"type\": 3,\r\n                                \"content\": {\r\n                                  \"version\": \"KqlItem/1.0\",\r\n                                  \"query\": \"AlertsManagementResources | where type =~ 'microsoft.alertsmanagement/alerts'\\r\\n| where todatetime(properties.essentials.startDateTime) {timeRange}  \\r\\n| extend State=tostring(properties.essentials.alertState)\\r\\n| where \\\"*\\\" in ({State}) or State in ({State})\\r\\n| where \\\"*\\\" in ({alertResources}) or properties.essentials.targetResource in~ ({alertResources})\\r\\n| summarize Alerts=count(), New=countif(State==\\\"New\\\"), \\r\\nAcknowledged=countif(State==\\\"Acknowledged\\\"), \\r\\nClosed=countif(State==\\\"Closed\\\")\\r\\nby Resource=tostring(properties.essentials.targetResource )\\r\\n| order by Alerts desc\\r\\n\",\r\n                                  \"size\": 3,\r\n                                  \"title\": \"Alerts by Region\",\r\n                                  \"noDataMessage\": \"No alerts\",\r\n                                  \"noDataMessageStyle\": 3,\r\n                                  \"queryType\": 1,\r\n                                  \"resourceType\": \"microsoft.resourcegraph/resources\",\r\n                                  \"crossComponentResources\": [\r\n                                    \"{Subscription}\"\r\n                                  ],\r\n                                  \"visualization\": \"map\",\r\n                                  \"mapSettings\": {\r\n                                    \"locInfo\": \"AzureResource\",\r\n                                    \"locInfoColumn\": \"Resource\",\r\n                                    \"sizeSettings\": \"Alerts\",\r\n                                    \"sizeAggregation\": \"Sum\",\r\n                                    \"legendMetric\": \"Alerts\",\r\n                                    \"legendAggregation\": \"Sum\",\r\n                                    \"itemColorSettings\": {\r\n                                      \"nodeColorField\": \"Alerts\",\r\n                                      \"colorAggregation\": \"Sum\",\r\n                                      \"type\": \"heatmap\",\r\n                                      \"heatmapPalette\": \"greenRed\"\r\n                                    }\r\n                                  }\r\n                                },\r\n                                \"conditionalVisibility\": {\r\n                                  \"parameterName\": \"tab\",\r\n                                  \"comparison\": \"isEqualTo\",\r\n                                  \"value\": \"region\"\r\n                                },\r\n                                \"name\": \"Alerts map\"\r\n                              }\r\n                            ]\r\n                          },\r\n                          \"conditionalVisibility\": {\r\n                            \"parameterName\": \"Severity\",\r\n                            \"comparison\": \"isNotEqualTo\"\r\n                          },\r\n                          \"name\": \"visible if severity selected\"\r\n                        }\r\n                      ]\r\n                    },\r\n                    \"conditionalVisibility\": {\r\n                      \"parameterName\": \"Subscription\",\r\n                      \"comparison\": \"isNotEqualTo\"\r\n                    },\r\n                    \"name\": \"visible if subscriptions selected\"\r\n                  }\r\n                ],\r\n                \"exportParameters\": true\r\n              },\r\n              \"conditionalVisibility\": {\r\n                \"parameterName\": \"mainAction\",\r\n                \"comparison\": \"isEqualTo\",\r\n                \"value\": \"alerts\"\r\n              },\r\n              \"name\": \"alerts-group\",\r\n              \"styleSettings\": {\r\n                \"margin\": \"15px 0px\",\r\n                \"showBorder\": true\r\n              }\r\n            }\r\n          ]\r\n        },\r\n        \"name\": \"Fleet Overview\"\r\n      }\r\n    ],\r\n    \"isLocked\": false,\r\n    \"defaultResourceIds\": [\r\n        \"{{appInsightsResourceId}}\",\r\n        \"{{iotHubResourceId}}\",\r\n        \"{{subscriptionResourceId}}\"\r\n    ],\r\n    \"fallbackResourceIds\": [\r\n        \"{{appInsightsResourceId}}\",\r\n        \"{{iotHubResourceId}}\",\r\n        \"{{subscriptionResourceId}}\"\r\n    ],\r\n    \"fromTemplateId\": \"community-Workbooks/IoTHub/IoT Edge\"\r\n  }",
                    "workbookDisplayName": "StarterKitWorkbook",
                    "workbookContent": "[replace(replace(replace(variables('$fxv#0'), '{{subscriptionResourceId}}', subscription().id), '{{appInsightsResourceId}}', resourceId('Microsoft.Insights/components', parameters('appInsightsName'))), '{{iotHubResourceId}}', resourceId('Microsoft.Devices/IotHubs', parameters('iothubName')))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/workbooks",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(variables('workbookDisplayName'))]",
                      "location": "[parameters('location')]",
                      "kind": "shared",
                      "properties": {
                        "displayName": "[variables('workbookDisplayName')]",
                        "serializedData": "[variables('workbookContent')]",
                        "version": "1.0",
                        "category": "workbook",
                        "sourceId": "[resourceId('Microsoft.Devices/IotHubs', parameters('iothubName'))]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', format('{0}insight', parameters('prefix')))]"
              ]
            },
            {
              "condition": "[parameters('useAzureMonitorOnEdge')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "azureMonitorAlerts",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "appInsightsName": {
                    "value": "[format('{0}insight', parameters('prefix'))]"
                  },
                  "iothubName": {
                    "value": "[parameters('iotHubName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.11.1.770",
                      "templateHash": "6940473478942790040"
                    }
                  },
                  "parameters": {
                    "iothubName": {
                      "type": "string"
                    },
                    "appInsightsName": {
                      "type": "string"
                    },
                    "alertSensitivity": {
                      "type": "string",
                      "defaultValue": "Medium",
                      "metadata": {
                        "description": "Dynamic Threshold sensitivity (High, Medium, Low)"
                      }
                    },
                    "evaluationPeriods": {
                      "type": "int",
                      "defaultValue": 4,
                      "metadata": {
                        "description": "Dynamic Threshold Failing Periods configurations https://docs.microsoft.com/azure/azure-monitor/alerts/alerts-dynamic-thresholds#what-do-the-advanced-settings-in-dynamic-thresholds-mean"
                      }
                    },
                    "failingPeriods": {
                      "type": "int",
                      "defaultValue": 4,
                      "metadata": {
                        "description": "Dynamic Threshold Failing Periods configurations https://docs.microsoft.com/azure/azure-monitor/alerts/alerts-dynamic-thresholds#what-do-the-advanced-settings-in-dynamic-thresholds-mean"
                      }
                    },
                    "metricNamespace": {
                      "type": "string",
                      "defaultValue": "LoRaWan",
                      "metadata": {
                        "description": "Metric namespace for the alert. Default is LoRaWan"
                      }
                    },
                    "evaluationFrequency": {
                      "type": "string",
                      "defaultValue": "PT1H",
                      "metadata": {
                        "description": "Every hour (5 mins, 15 mins, 30 mins, etc.)"
                      }
                    },
                    "aggregationPeriod": {
                      "type": "string",
                      "defaultValue": "PT1H",
                      "metadata": {
                        "description": "1 hour (5 mins, 15 mins, 30 mins, etc.)"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "High Upstream Message Latency",
                      "location": "global",
                      "properties": {
                        "description": "High device message processing time (throughput)",
                        "severity": 2,
                        "enabled": true,
                        "evaluationFrequency": "[parameters('evaluationFrequency')]",
                        "windowSize": "[parameters('aggregationPeriod')]",
                        "autoMitigate": true,
                        "targetResourceType": "microsoft.insights/components",
                        "actions": [],
                        "scopes": [
                          "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
                        ],
                        "criteria": {
                          "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
                          "allOf": [
                            {
                              "alertSensitivity": "[parameters('alertSensitivity')]",
                              "failingPeriods": {
                                "numberOfEvaluationPeriods": "[parameters('evaluationPeriods')]",
                                "minFailingPeriodsToAlert": "[parameters('failingPeriods')]"
                              },
                              "name": "Metric1",
                              "metricNamespace": "[parameters('metricNamespace')]",
                              "metricName": "D2CMessageDeliveryLatency",
                              "dimensions": [
                                {
                                  "name": "GatewayId",
                                  "operator": "Include",
                                  "values": [
                                    "*"
                                  ]
                                }
                              ],
                              "operator": "GreaterThan",
                              "timeAggregation": "Average",
                              "criterionType": "DynamicThresholdCriterion",
                              "skipMetricValidation": true
                            }
                          ]
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "High Receive Window Misses",
                      "location": "global",
                      "properties": {
                        "description": "High receive window misses (throughput)",
                        "severity": 2,
                        "enabled": true,
                        "evaluationFrequency": "[parameters('evaluationFrequency')]",
                        "windowSize": "[parameters('aggregationPeriod')]",
                        "autoMitigate": true,
                        "targetResourceType": "microsoft.insights/components",
                        "actions": [],
                        "scopes": [
                          "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
                        ],
                        "criteria": {
                          "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
                          "allOf": [
                            {
                              "alertSensitivity": "[parameters('alertSensitivity')]",
                              "failingPeriods": {
                                "numberOfEvaluationPeriods": "[parameters('evaluationPeriods')]",
                                "minFailingPeriodsToAlert": "[parameters('failingPeriods')]"
                              },
                              "name": "Metric1",
                              "metricNamespace": "[parameters('metricNamespace')]",
                              "metricName": "ReceiveWindowMisses",
                              "dimensions": [
                                {
                                  "name": "GatewayId",
                                  "operator": "Include",
                                  "values": [
                                    "*"
                                  ]
                                }
                              ],
                              "operator": "GreaterThan",
                              "timeAggregation": "Average",
                              "criterionType": "DynamicThresholdCriterion",
                              "skipMetricValidation": true
                            }
                          ]
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "Unhandled Exceptions",
                      "location": "global",
                      "properties": {
                        "description": "High error count (correctness)",
                        "severity": 2,
                        "enabled": true,
                        "evaluationFrequency": "[parameters('evaluationFrequency')]",
                        "windowSize": "[parameters('aggregationPeriod')]",
                        "autoMitigate": true,
                        "targetResourceType": "microsoft.insights/components",
                        "actions": [],
                        "scopes": [
                          "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
                        ],
                        "criteria": {
                          "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
                          "allOf": [
                            {
                              "alertSensitivity": "[parameters('alertSensitivity')]",
                              "failingPeriods": {
                                "numberOfEvaluationPeriods": "[parameters('evaluationPeriods')]",
                                "minFailingPeriodsToAlert": "[parameters('failingPeriods')]"
                              },
                              "name": "Metric1",
                              "metricNamespace": "[parameters('metricNamespace')]",
                              "metricName": "UnhandledExceptions",
                              "operator": "GreaterThan",
                              "timeAggregation": "Count",
                              "criterionType": "DynamicThresholdCriterion",
                              "skipMetricValidation": true
                            }
                          ]
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "High Downstream Messages Abandoned Number",
                      "location": "global",
                      "properties": {
                        "description": "High device messages abandoned number (correctness, throughput)",
                        "severity": 2,
                        "enabled": true,
                        "evaluationFrequency": "[parameters('evaluationFrequency')]",
                        "windowSize": "[parameters('aggregationPeriod')]",
                        "autoMitigate": true,
                        "targetResourceType": "microsoft.devices/iothubs",
                        "actions": [],
                        "scopes": [
                          "[resourceId('Microsoft.Devices/IotHubs', parameters('iothubName'))]"
                        ],
                        "criteria": {
                          "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
                          "allOf": [
                            {
                              "alertSensitivity": "[parameters('alertSensitivity')]",
                              "failingPeriods": {
                                "numberOfEvaluationPeriods": "[parameters('evaluationPeriods')]",
                                "minFailingPeriodsToAlert": "[parameters('failingPeriods')]"
                              },
                              "name": "Metric1",
                              "metricNamespace": "Microsoft.Devices/IotHubs",
                              "metricName": "c2d.commands.egress.abandon.success",
                              "operator": "GreaterThan",
                              "timeAggregation": "Average",
                              "criterionType": "DynamicThresholdCriterion",
                              "skipMetricValidation": true
                            }
                          ]
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "High Downstream Messages Rejected Number",
                      "location": "global",
                      "properties": {
                        "description": "High device messages rejected number (correctness, throughput)",
                        "severity": 2,
                        "enabled": true,
                        "evaluationFrequency": "[parameters('evaluationFrequency')]",
                        "windowSize": "[parameters('aggregationPeriod')]",
                        "autoMitigate": true,
                        "targetResourceType": "microsoft.devices/iothubs",
                        "actions": [],
                        "scopes": [
                          "[resourceId('Microsoft.Devices/IotHubs', parameters('iothubName'))]"
                        ],
                        "criteria": {
                          "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
                          "allOf": [
                            {
                              "alertSensitivity": "[parameters('alertSensitivity')]",
                              "failingPeriods": {
                                "numberOfEvaluationPeriods": "[parameters('evaluationPeriods')]",
                                "minFailingPeriodsToAlert": "[parameters('failingPeriods')]"
                              },
                              "name": "Metric1",
                              "metricNamespace": "Microsoft.Devices/IotHubs",
                              "metricName": "c2d.commands.egress.reject.success",
                              "operator": "GreaterThan",
                              "timeAggregation": "Average",
                              "criterionType": "DynamicThresholdCriterion",
                              "skipMetricValidation": true
                            }
                          ]
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "High Upstream Messages Lost Ratio",
                      "location": "global",
                      "properties": {
                        "description": "High Upstream Messages Lost Ratio (Correctness) (D2CMessagesReceived/D2CMessagesDelivered)",
                        "severity": 2,
                        "enabled": true,
                        "evaluationFrequency": "[parameters('evaluationFrequency')]",
                        "windowSize": "[parameters('aggregationPeriod')]",
                        "autoMitigate": true,
                        "targetResourceType": "microsoft.insights/components",
                        "actions": [],
                        "scopes": [
                          "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
                        ],
                        "criteria": {
                          "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
                          "allOf": [
                            {
                              "alertSensitivity": "[parameters('alertSensitivity')]",
                              "failingPeriods": {
                                "numberOfEvaluationPeriods": "[parameters('evaluationPeriods')]",
                                "minFailingPeriodsToAlert": "[parameters('failingPeriods')]"
                              },
                              "name": "Metric1",
                              "metricNamespace": "[parameters('metricNamespace')]",
                              "metricName": "D2CMessagesLostRatio",
                              "dimensions": [
                                {
                                  "name": "GatewayId",
                                  "operator": "Include",
                                  "values": [
                                    "*"
                                  ]
                                }
                              ],
                              "operator": "GreaterThan",
                              "timeAggregation": "Average",
                              "criterionType": "DynamicThresholdCriterion",
                              "skipMetricValidation": true
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', format('{0}insight', parameters('prefix')))]"
              ]
            }
          ],
          "outputs": {
            "appInsightName": {
              "type": "string",
              "value": "[format('{0}insight', parameters('prefix'))]"
            },
            "logAnalyticsName": {
              "type": "string",
              "value": "[format('{0}analytics', parameters('prefix'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'iotHub')]"
      ]
    },
    {
      "condition": "[parameters('useDiscoveryService')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "discoveryService",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'observability')).outputs.appInsightName.value]"
          },
          "version": {
            "value": "[parameters('version')]"
          },
          "gitUsername": {
            "value": "[parameters('gitUsername')]"
          },
          "iotHubName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'iotHub')).outputs.iotHubName.value]"
          },
          "uniqueSolutionPrefix": {
            "value": "[parameters('uniqueSolutionPrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "18037453640334460411"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "sku": {
              "type": "string",
              "defaultValue": "B1"
            },
            "version": {
              "type": "string"
            },
            "iotHubName": {
              "type": "string"
            },
            "appInsightName": {
              "type": "string"
            },
            "roleNameGuid": {
              "type": "string",
              "defaultValue": "[guid(resourceGroup().id, 'twincontributor')]"
            },
            "uniqueSolutionPrefix": {
              "type": "string"
            },
            "gitUsername": {
              "type": "string"
            }
          },
          "variables": {
            "webAppName": "[format('{0}discovery', parameters('uniqueSolutionPrefix'))]",
            "hostingPlanName": "[format('{0}plan', variables('webAppName'))]",
            "aspNetCoreUrls": "http://0.0.0.0:80;https://0.0.0.0:443",
            "discoveryZipUrl": "[format('https://github.com/{0}/iotedge-lorawan-starterkit/releases/download/v{1}/discoveryservice-{2}.zip', parameters('gitUsername'), parameters('version'), parameters('version'))]",
            "iotHubTwinContributorRoleId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '494bdba2-168f-4f31-a0a1-191d2f7c028c')]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-03-01",
              "name": "[variables('hostingPlanName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('sku')]"
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-03-01",
              "name": "[variables('webAppName')]",
              "location": "[parameters('location')]",
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
                "siteConfig": {
                  "appSettings": [
                    {
                      "name": "IotHubHostName",
                      "value": "[reference(resourceId('Microsoft.Devices/IotHubs', parameters('iotHubName')), '2021-07-02').hostName]"
                    },
                    {
                      "name": "WEBSITE_RUN_FROM_PACKAGE",
                      "value": "[variables('discoveryZipUrl')]"
                    },
                    {
                      "name": "ASPNETCORE_URLS",
                      "value": "[variables('aspNetCoreUrls')]"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightName')), '2020-02-02').InstrumentationKey]"
                    }
                  ],
                  "webSocketsEnabled": true
                }
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Devices/IotHubs/{0}', parameters('iotHubName'))]",
              "name": "[parameters('roleNameGuid')]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.Web/sites', variables('webAppName')), '2022-03-01', 'full').identity.principalId]",
                "roleDefinitionId": "[variables('iotHubTwinContributorRoleId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'iotHub')]",
        "[resourceId('Microsoft.Resources/deployments', 'observability')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "createDevices",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "deployDevice": {
            "value": "[parameters('deployDevice')]"
          },
          "logAnalyticsName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'observability')).outputs.logAnalyticsName.value]"
          },
          "functionAppName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'function')).outputs.functionName.value]"
          },
          "iothubName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'iotHub')).outputs.iotHubName.value]"
          },
          "edgeGatewayName": {
            "value": "[parameters('edgeGatewayName')]"
          },
          "resetPin": {
            "value": "[parameters('resetPin')]"
          },
          "region": {
            "value": "[parameters('region')]"
          },
          "stationEui": {
            "value": "[parameters('stationEui')]"
          },
          "spiSpeed": {
            "value": "[parameters('spiSpeed')]"
          },
          "spiDev": {
            "value": "[parameters('spiDev')]"
          },
          "loraCliUrl": {
            "value": "[parameters('loraCliUrl')]"
          },
          "version": {
            "value": "[parameters('version')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "303659992482609601"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "iothubName": {
              "type": "string"
            },
            "edgeGatewayName": {
              "type": "string"
            },
            "resetPin": {
              "type": "int"
            },
            "spiSpeed": {
              "type": "int"
            },
            "spiDev": {
              "type": "int"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "functionAppName": {
              "type": "string"
            },
            "region": {
              "type": "string"
            },
            "stationEui": {
              "type": "string"
            },
            "lnsHostAddress": {
              "type": "string",
              "defaultValue": "ws://mylns:5000"
            },
            "useAzureMonitorOnEdge": {
              "type": "bool",
              "defaultValue": true
            },
            "logAnalyticsName": {
              "type": "string"
            },
            "deployDevice": {
              "type": "bool"
            },
            "loraCliUrl": {
              "type": "string"
            },
            "version": {
              "type": "string"
            }
          },
          "variables": {
            "$fxv#0": "create_devices_with_lora_cli() {\n    echo \"Downloading lora-cli from $LORA_CLI_URL...\"\n    curl -SsL \"$LORA_CLI_URL\" -o lora-cli.tar.gz\n    mkdir -p lora-cli && tar -xzf ./lora-cli.tar.gz -C ./lora-cli\n\n    cd lora-cli\n    chmod +x ./loradeviceprovisioning\n\n    local monitoringEnabled=\"false\"\n    if [ \"${MONITORING_ENABLED}\" = \"1\" ]; then\n        monitoringEnabled=\"true\"\n    fi\n\n    echo \"Creating gateway $EDGE_GATEWAY_NAME...\"\n    ./loradeviceprovisioning add-gateway --reset-pin \"$RESET_PIN\" --device-id \"$EDGE_GATEWAY_NAME\" --spi-dev \"$SPI_DEV\" --spi-speed \"$SPI_SPEED\" --api-url \"$FACADE_SERVER_URL\" --api-key \"$FACADE_AUTH_CODE\" --lns-host-address \"$LNS_HOST_ADDRESS\" --network \"$NETWORK\" --monitoring \"$monitoringEnabled\" --iothub-resource-id \"$IOTHUB_RESOURCE_ID\" --log-analytics-workspace-id \"$LOG_ANALYTICS_WORKSPACE_ID\" --log-analytics-shared-key \"$LOG_ANALYTICS_SHARED_KEY\" --lora-version \"$LORA_VERSION\"\n\n    echo \"Creating concentrator $STATION_DEVICE_NAME for region $REGION...\"\n    ./loradeviceprovisioning add --type concentrator --region \"$REGION\" --stationeui \"$STATION_DEVICE_NAME\" --no-cups --network \"$NETWORK\"\n\n    # add leaf devices\n    if [ \"${DEPLOY_DEVICE}\" = \"1\" ]; then\n        echo \"Creating leaf devices 46AAC86800430028 and 47AAC86800430028...\"\n        ./loradeviceprovisioning add --type abp --deveui \"46AAC86800430028\" --appskey \"2B7E151628AED2A6ABF7158809CF4F3C\" --nwkskey \"3B7E151628AED2A6ABF7158809CF4F3C\" --devaddr \"0228B1B1\" --decoder \"DecoderValueSensor\" --network \"$NETWORK\"\n        ./loradeviceprovisioning add --type otaa --deveui \"47AAC86800430028\" --appeui \"BE7A0000000014E2\" --appkey \"8AFE71A145B253E49C3031AD068277A1\" --decoder \"DecoderValueSensor\" --network \"$NETWORK\"\n    fi\n}\n\n# Setting default values\nSTATION_DEVICE_NAME=${STATION_DEVICE_NAME:-AA555A0000000101}\nREGION=${REGION:-EU863}\nNETWORK=${NETWORK-quickstartnetwork}\nLNS_HOST_ADDRESS=${LNS_HOST_ADDRESS-ws://mylns:5000}\nSPI_DEV=${SPI_DEV-0}\nSPI_SPEED=${SPI_SPEED-8}\n\ncreate_devices_with_lora_cli\n"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "createIothubDevices",
              "kind": "AzureCLI",
              "location": "[parameters('location')]",
              "properties": {
                "forceUpdateTag": "[parameters('utcValue')]",
                "azCliVersion": "2.40.0",
                "cleanupPreference": "OnSuccess",
                "timeout": "PT10M",
                "retentionInterval": "P1D",
                "environmentVariables": [
                  {
                    "name": "IOTHUB_RESOURCE_ID",
                    "value": "[resourceId('Microsoft.Devices/IotHubs', parameters('iothubName'))]"
                  },
                  {
                    "name": "IOTHUB_CONNECTION_STRING",
                    "secureValue": "[format('HostName={0}.azure-devices.net;SharedAccessKeyName={1};SharedAccessKey={2}', parameters('iothubName'), listKeys(resourceId('Microsoft.Devices/IotHubs', parameters('iothubName')), '2020-04-01').value[0].keyName, listKeys(resourceId('Microsoft.Devices/IotHubs', parameters('iothubName')), '2020-04-01').value[0].primaryKey)]"
                  },
                  {
                    "name": "LOG_ANALYTICS_WORKSPACE_ID",
                    "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName')), '2022-10-01').customerId]"
                  },
                  {
                    "name": "LOG_ANALYTICS_SHARED_KEY",
                    "secureValue": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName')), '2022-10-01').primarySharedKey]"
                  },
                  {
                    "name": "EDGE_GATEWAY_NAME",
                    "value": "[parameters('edgeGatewayName')]"
                  },
                  {
                    "name": "STATION_DEVICE_NAME",
                    "value": "[parameters('stationEui')]"
                  },
                  {
                    "name": "RESET_PIN",
                    "value": "[string(parameters('resetPin'))]"
                  },
                  {
                    "name": "SPI_SPEED",
                    "value": "[string(parameters('spiSpeed'))]"
                  },
                  {
                    "name": "SPI_DEV",
                    "value": "[string(parameters('spiDev'))]"
                  },
                  {
                    "name": "FACADE_AUTH_CODE",
                    "secureValue": "[listkeys(format('{0}/host/default', resourceId('Microsoft.Web/sites', parameters('functionAppName'))), '2016-08-01').functionKeys.default]"
                  },
                  {
                    "name": "FACADE_SERVER_URL",
                    "value": "[format('https://{0}.azurewebsites.net/api', parameters('functionAppName'))]"
                  },
                  {
                    "name": "NETWORK",
                    "value": "quickstartnetwork"
                  },
                  {
                    "name": "LNS_HOST_ADDRESS",
                    "value": "[parameters('lnsHostAddress')]"
                  },
                  {
                    "name": "REGION",
                    "value": "[toLower(parameters('region'))]"
                  },
                  {
                    "name": "MONITORING_ENABLED",
                    "value": "[if(parameters('useAzureMonitorOnEdge'), '1', '0')]"
                  },
                  {
                    "name": "DEPLOY_DEVICE",
                    "value": "[if(parameters('deployDevice'), '1', '0')]"
                  },
                  {
                    "name": "LORA_CLI_URL",
                    "value": "[parameters('loraCliUrl')]"
                  },
                  {
                    "name": "LORA_VERSION",
                    "value": "[parameters('version')]"
                  }
                ],
                "scriptContent": "[variables('$fxv#0')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'function')]",
        "[resourceId('Microsoft.Resources/deployments', 'iotHub')]",
        "[resourceId('Microsoft.Resources/deployments', 'observability')]"
      ]
    }
  ]
}